<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0">
<meta name="theme-color" content="#060d1a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Portail Tech">
<title>Portail Tech â€“ Bertin</title>
<link rel="manifest" href="manifest.json">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VARIABLES & RESET
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{--bg:#060d1a;--bg2:#0b1529;--bg3:#101e36;--panel:#121f38;--panel2:#172540;--border:#1e3258;--border2:#243d6e;--accent:#00d4ff;--accent2:#0099cc;--green:#00e676;--orange:#ff9800;--red:#ff3d3d;--yellow:#ffd600;--text:#eef4ff;--text2:#9dc0e0;--text3:#5a7fa0;--mono:'Courier New',monospace;--title:system-ui,sans-serif;--body:system-ui,sans-serif}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px}body{font-family:var(--body);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;-webkit-tap-highlight-color:transparent}
body::before{content:'';position:fixed;inset:0;z-index:0;background-image:linear-gradient(rgba(0,212,255,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,.04) 1px,transparent 1px);background-size:40px 40px;pointer-events:none}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header{position:sticky;top:0;z-index:100;background:linear-gradient(180deg,#0b1a35,var(--bg2));border-bottom:1px solid var(--border2);padding:0 16px;box-shadow:0 4px 40px rgba(0,212,255,.08)}
.htop{display:flex;align-items:center;gap:12px;padding:14px 0 8px}
.logo{display:flex;align-items:center;justify-content:center;width:46px;height:46px;border:2px solid var(--accent);border-radius:8px;font-size:24px;background:rgba(0,212,255,.06)}
.htitle{font-size:1.25rem;font-weight:700;letter-spacing:.06em}.hsub{font-family:var(--mono);font-size:.6rem;color:var(--accent);letter-spacing:.12em;margin-top:3px}
.hright{margin-left:auto;text-align:right}
.hdate{font-family:var(--mono);font-size:.55rem;color:var(--text3);line-height:1.6}
.scanl{height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);background-size:200%;animation:sc 2.5s linear infinite}
@keyframes sc{0%{background-position:-200% 0}100%{background-position:200% 0}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INSTALL BANNER (Android PWA)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.install-bar{display:none;align-items:center;gap:10px;padding:8px 16px;background:rgba(0,212,255,.08);border-bottom:1px solid var(--accent2)}
.install-bar.show{display:flex}
.install-bar span{font-family:var(--mono);font-size:.72rem;color:var(--accent);flex:1}
.install-btn{padding:6px 16px;background:var(--accent);color:var(--bg);border:none;border-radius:6px;font-weight:700;font-size:.78rem;cursor:pointer}
.install-btn:active{opacity:.8}
.install-close{background:none;border:none;color:var(--text3);font-size:1.1rem;cursor:pointer;padding:4px 8px}

/* UPDATE BANNER */
.update-bar{display:none;align-items:center;gap:10px;padding:10px 16px;background:rgba(0,230,118,.08);border-bottom:1px solid var(--green);cursor:pointer;animation:updatePulse 2s ease-in-out infinite}
.update-bar.show{display:flex}
.update-bar span{font-family:var(--mono);font-size:.75rem;color:var(--green);flex:1}
.update-bar .update-btn{padding:6px 16px;background:var(--green);color:var(--bg);border:none;border-radius:6px;font-weight:700;font-size:.78rem;cursor:pointer}
@keyframes updatePulse{0%,100%{background:rgba(0,230,118,.08)}50%{background:rgba(0,230,118,.15)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tabs{display:flex;gap:6px;padding:12px 12px 8px;position:relative;z-index:10;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch}.tabs::-webkit-scrollbar{display:none}
.tab{flex:0 0 auto;min-width:0;display:flex;align-items:center;gap:8px;padding:12px 10px;background:var(--panel);border:1.5px solid var(--border);border-radius:10px;color:var(--text);cursor:pointer;transition:all .15s}
.tab:active{transform:scale(.97)}.tab.active{border-color:var(--accent);background:rgba(0,212,255,.06);box-shadow:0 0 0 1px rgba(0,212,255,.15),0 4px 20px rgba(0,212,255,.08)}
.tab .ti{font-size:1.3rem}.tab .tt{font-size:.78rem;font-weight:700;letter-spacing:.04em;line-height:1}.tab .td{font-family:var(--mono);font-size:.5rem;color:var(--text3)}
.tab.active .tt{color:var(--accent)}.tab.active .td{color:var(--accent2)}
.tab .tb{margin-left:auto;font-family:var(--mono);font-size:.6rem;color:var(--text3);background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:1px 6px}
.tab.active .tb{background:rgba(0,212,255,.1);border-color:var(--accent2);color:var(--accent)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGES & TOOLBAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page{display:none;position:relative;z-index:10}.page.active{display:block}
.tbar{padding:10px 14px;display:flex;gap:8px}
.sbox{flex:1;position:relative}.sbox input{width:100%;height:42px;background:var(--panel);border:1.5px solid var(--border);border-radius:6px;color:var(--text);font-size:.88rem;padding:0 12px 0 36px;outline:none;-webkit-appearance:none}
.sbox input:focus{border-color:var(--accent)}.sbox input::placeholder{color:var(--text3)}.sbox .si{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:.85rem;pointer-events:none}
.frow{display:flex;gap:6px;overflow-x:auto;padding:4px 14px 8px;scrollbar-width:none}.frow::-webkit-scrollbar{display:none}
.fbtn{flex-shrink:0;padding:4px 11px;background:var(--panel);border:1.5px solid var(--border);border-radius:16px;color:var(--text2);font-size:.72rem;font-weight:600;cursor:pointer;white-space:nowrap}
.fbtn.active{background:rgba(0,212,255,.1);border-color:var(--accent);color:var(--accent)}
.lcount{font-family:var(--mono);font-size:.7rem;color:var(--text3);padding:2px 14px 8px}.lcount span{color:var(--accent);font-size:.8rem}
.list{display:flex;flex-direction:column;gap:6px;padding:0 10px 80px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS â€” Ã‰talons
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ec{background:var(--panel);border:1.5px solid var(--border);border-radius:10px;padding:12px;cursor:pointer;transition:all .15s;animation:ci .3s ease both}
@keyframes ci{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.ec:active{border-color:var(--accent);background:var(--panel2)}
.ec .r1{display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap}
.eid{font-family:var(--mono);font-size:.88rem;font-weight:700;color:var(--accent)}.ecat{font-family:var(--mono);font-size:.56rem;color:var(--text3);text-transform:uppercase;background:var(--bg3);border:1px solid var(--border);padding:1px 6px;border-radius:10px}
.vb{margin-left:auto;font-family:var(--mono);font-size:.56rem;padding:2px 7px;border-radius:10px;flex-shrink:0}
.vv{background:rgba(0,230,118,.1);border:1px solid rgba(0,230,118,.3);color:var(--green)}.vp{background:rgba(0,212,255,.08);border:1px solid rgba(0,212,255,.25);color:var(--accent)}
.vb2{background:rgba(255,152,0,.1);border:1px solid rgba(255,152,0,.3);color:var(--orange)}.ve{background:rgba(255,61,61,.1);border:1px solid rgba(255,61,61,.3);color:var(--red)}
.vi{background:var(--bg3);border:1px solid var(--border);color:var(--text3)}
.ec .r2{font-size:.76rem;color:var(--text2)}.ec .r2 b{color:var(--text);font-weight:600}
.ec .r3{display:flex;flex-wrap:wrap;gap:3px 6px;margin-top:6px}
.ctag{font-family:var(--mono);font-size:.58rem;color:var(--text2);background:var(--bg2);border:1px solid var(--border);padding:1px 6px;border-radius:3px}.ctag i{color:var(--text3);font-style:normal}
.ctag.act{border-color:var(--green);color:var(--green);font-weight:700}
.badge-local{font-family:var(--mono);font-size:.5rem;padding:1px 5px;border-radius:8px;background:rgba(255,152,0,.15);border:1px solid var(--orange);color:var(--orange)}
.badge-ce{margin-left:4px;font-size:.75rem}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS â€” MatÃ©riels
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mc{background:var(--panel);border:1.5px solid var(--border);border-radius:10px;padding:10px 12px;cursor:pointer;transition:all .15s;animation:ci .3s ease both}
.mc:active{border-color:var(--accent);background:var(--panel2)}
.mc .r1{display:flex;align-items:center;gap:6px;margin-bottom:3px}.mid{font-family:var(--mono);font-size:.72rem;font-weight:700;color:var(--accent);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:55%}
.mctr{font-family:var(--mono);font-size:.54rem;color:var(--text3);text-transform:uppercase;background:var(--bg3);border:1px solid var(--border);padding:1px 5px;border-radius:10px}
.mc .r2{font-size:.76rem;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.mc .r3{font-family:var(--mono);font-size:.58rem;color:var(--text3);margin-top:3px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS â€” Constats
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;padding:0 10px 80px}
.cc{background:var(--panel);border:1.5px solid var(--border);border-radius:10px;padding:16px 12px 14px;cursor:pointer;text-decoration:none;display:flex;flex-direction:column;align-items:center;gap:8px;transition:all .15s;animation:ci .35s ease both}
.cc:active{border-color:var(--accent);background:var(--panel2)}.cc .ci{font-size:2rem}.cc .ct{font-size:.85rem;font-weight:700;text-align:center;line-height:1.3}.cc .cd{font-size:.68rem;color:var(--text2);text-align:center}.cc .ck{font-family:var(--mono);font-size:.58rem;color:var(--text3);text-transform:uppercase;background:var(--bg3);border:1px solid var(--border);padding:1px 7px;border-radius:10px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mo{display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.75);align-items:flex-end;justify-content:center}
.mo.open{display:flex;animation:fi .2s}@keyframes fi{from{opacity:0}to{opacity:1}}
.md{background:var(--bg3);border:1px solid var(--border2);border-radius:16px 16px 0 0;width:100%;max-width:540px;max-height:88vh;overflow-y:auto;animation:su .25s ease}
@keyframes su{from{transform:translateY(40px)}to{transform:translateY(0)}}
.mh{position:sticky;top:0;z-index:10;background:var(--bg3);padding:18px 18px 10px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:10px}
.mh h2{font-size:1.05rem;color:var(--accent);flex:1;word-break:break-word}.mx{width:32px;height:32px;flex-shrink:0;background:var(--panel);border:1.5px solid var(--border);border-radius:8px;color:var(--text2);font-size:.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.mb{padding:14px 18px 28px}
.ds{margin-bottom:16px}.ds h3{font-family:var(--mono);font-size:.65rem;color:var(--text3);letter-spacing:.1em;text-transform:uppercase;margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--border)}
.dr{display:flex;justify-content:space-between;align-items:baseline;padding:4px 0;gap:10px}.dl{font-size:.78rem;color:var(--text2);flex-shrink:0}.dv{font-family:var(--mono);font-size:.78rem;color:var(--text);text-align:right;word-break:break-word}.dv.ac{color:var(--accent)}
.dobs{font-size:.8rem;color:var(--text2);line-height:1.5;margin-top:6px;padding:8px;background:var(--bg2);border:1px solid var(--border);border-radius:6px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMS & BUTTONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fg{margin-bottom:12px}.fg label{display:block;font-size:.75rem;color:var(--text2);margin-bottom:4px;font-weight:600}
.fg input,.fg select,.fg textarea{width:100%;height:40px;background:var(--panel);border:1.5px solid var(--border);border-radius:6px;color:var(--text);font-size:.85rem;padding:0 10px;outline:none;font-family:var(--body)}.fg input:focus,.fg select:focus{border-color:var(--accent)}.fg select{-webkit-appearance:none;appearance:none}
.fg textarea{height:60px;padding:8px 10px;resize:vertical}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;height:40px;padding:0 18px;border-radius:6px;font-size:.85rem;font-weight:600;cursor:pointer;border:1.5px solid;transition:all .15s}
.btn:active{transform:scale(.96)}
.btn-primary{background:rgba(0,212,255,.1);border-color:var(--accent);color:var(--accent)}.btn-danger{background:rgba(255,61,61,.08);border-color:var(--red);color:var(--red)}
.btn-ghost{background:transparent;border-color:var(--border);color:var(--text2)}.btn-green{background:rgba(0,230,118,.08);border-color:var(--green);color:var(--green)}
.btn-row{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap}
.fab{position:fixed;bottom:16px;right:14px;z-index:50;width:50px;height:50px;background:rgba(0,212,255,.12);border:1.5px solid var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.4rem;color:var(--accent);cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,.4)}.fab:active{transform:scale(.9)}
.action-bar{display:flex;gap:8px;padding:8px 14px;position:relative;z-index:10}
.empty{display:flex;flex-direction:column;align-items:center;padding:50px 20px;gap:12px;color:var(--text3);text-align:center}.empty .ei{font-size:2.5rem;opacity:.5}.empty .et{font-size:1rem;color:var(--text2)}.empty .es{font-size:.8rem;line-height:1.5;max-width:280px}
.chip-list{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0}.chip{display:flex;align-items:center;gap:4px;padding:4px 10px;background:var(--panel);border:1px solid var(--border);border-radius:16px;font-size:.75rem;color:var(--text2)}
.chip .chip-x{cursor:pointer;color:var(--red);font-weight:700;margin-left:2px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALCULETTE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.calc-tabs{display:flex;gap:0;padding:10px 14px 0;position:relative;z-index:10}
.calc-tab{flex:1;padding:10px 8px;background:var(--panel);border:1.5px solid var(--border);border-bottom:none;border-radius:8px 8px 0 0;color:var(--text2);font-family:var(--mono);font-size:.75rem;font-weight:700;cursor:pointer;transition:all .15s;letter-spacing:.04em}
.calc-tab.active{background:var(--panel2);border-color:var(--accent);color:var(--accent)}
.calc-panel{display:none}.calc-panel.active{display:block}
.calc-section{background:var(--panel);border:1.5px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}
.calc-title{font-family:var(--mono);font-size:.7rem;color:var(--accent);letter-spacing:.08em;text-transform:uppercase;margin-bottom:10px;font-weight:700}
.calc-info{font-family:var(--mono);font-size:.75rem;color:var(--text2);padding:8px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;margin-top:6px;line-height:1.6}
.calc-info .ai{color:var(--green);font-weight:700;font-size:.85rem}
.calc-results{display:flex;flex-direction:column;gap:10px}
.kr{padding:14px;background:var(--bg2);border-radius:10px;border:2px solid var(--border)}
.kr .kl{font-size:.75rem;color:var(--text2);margin-bottom:4px;font-family:var(--mono);letter-spacing:.05em}
.kr .kv{font-family:var(--mono);font-size:1.3rem;font-weight:700;color:var(--text)}
.kr .ku{font-size:.7rem;color:var(--text3);margin-left:6px}
.kr.ok{border-color:var(--green);background:rgba(0,230,118,.06)}.kr.ok .kv{color:var(--green)}
.kr.ko{border-color:var(--red);background:rgba(255,61,61,.06)}.kr.ko .kv{color:var(--red)}
.kr.na .kv{color:var(--text)}
.kr .kb{display:inline-block;font-family:var(--mono);font-size:.65rem;padding:3px 10px;border-radius:10px;margin-left:10px;vertical-align:middle}
.kr.ok .kb{background:rgba(0,230,118,.15);border:1px solid rgba(0,230,118,.4);color:var(--green)}
.kr.ko .kb{background:rgba(255,61,61,.15);border:1px solid rgba(255,61,61,.4);color:var(--red)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ã‰TIQUETTES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.eq-bar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;align-items:stretch}
.eq-bar .eq-row1{display:flex;gap:8px;width:100%;align-items:stretch}
.eq-bar .eq-row2{display:flex;gap:8px;width:100%;align-items:stretch}
.eq-bar input{flex:1;min-width:0;height:46px;background:var(--panel);border:1.5px solid var(--accent);border-radius:6px;color:var(--accent);font-size:.88rem;padding:0 10px;outline:none;font-family:var(--mono);font-weight:700}
.eq-bar input:focus{border-color:var(--accent)}
.eq-bar input::placeholder{color:var(--text3);font-weight:400;font-family:var(--body)}
.eq-bar select{flex:0 0 auto;width:auto;min-width:110px;height:46px;background:var(--panel);border:1.5px solid var(--border);border-radius:6px;color:var(--text);font-size:.85rem;padding:0 10px;outline:none;font-family:var(--mono);font-weight:700;-webkit-appearance:none;appearance:none}
.eq-bar select:focus{border-color:var(--accent)}
.eq-bar select.type-c{border-color:var(--green);color:var(--green);background:rgba(0,230,118,.08)}
.eq-bar select.type-nc{border-color:var(--red);color:var(--red);background:rgba(255,61,61,.08)}
.eq-scan{flex-shrink:0;width:46px;height:46px;background:var(--panel);border:1.5px solid var(--accent);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;cursor:pointer;position:relative}
.eq-scan:active{background:var(--panel2)}
.eq-scan .eq-scan-hint{position:absolute;bottom:-14px;font-size:.45rem;color:var(--text3);font-family:var(--mono);white-space:nowrap}
.eq-add{flex:1;height:46px;background:rgba(0,230,118,.12);border:1.5px solid var(--green);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1rem;cursor:pointer;gap:6px;color:var(--green);font-weight:700;font-family:var(--mono)}
.eq-add:active{background:rgba(0,230,118,.2)}
.eq-list{display:flex;flex-direction:column;gap:8px;margin:10px 0}
.eq-item{background:var(--panel);border:1.5px solid var(--border);border-radius:8px;padding:10px 12px;display:flex;align-items:center;gap:10px;animation:ci .35s ease both}
.eq-item .eq-type{font-family:var(--mono);font-size:.6rem;font-weight:700;padding:3px 8px;border-radius:4px;flex-shrink:0}
.eq-item .eq-type.c{background:rgba(0,230,118,.12);border:1px solid var(--green);color:var(--green)}
.eq-item .eq-type.nc{background:rgba(255,61,61,.12);border:1px solid var(--red);color:var(--red)}
.eq-item .eq-mid{flex:1;min-width:0}
.eq-item .eq-id{font-family:var(--mono);font-size:.85rem;font-weight:700;color:var(--accent)}
.eq-item .eq-des{font-size:.7rem;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.eq-item .eq-dates{font-family:var(--mono);font-size:.6rem;color:var(--text3)}
.eq-item .eq-del{width:32px;height:32px;background:none;border:1px solid var(--border);border-radius:6px;color:var(--red);font-size:.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.eq-preview{background:#fff;border-radius:6px;padding:2px;margin:8px auto;width:fit-content}
.eq-preview canvas{display:block}
#qrModal{display:none;position:fixed;inset:0;z-index:800;background:rgba(0,0,0,.9);flex-direction:column;align-items:center;justify-content:center}
#qrModal.open{display:flex}
#qrModal video{width:90%;max-width:400px;border-radius:12px;border:3px solid var(--accent)}
#qrModal .qr-close{margin-top:16px;padding:12px 32px;background:var(--panel2);border:1.5px solid var(--border2);border-radius:8px;color:var(--text);font-size:1rem;cursor:pointer}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST & CONFIRM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{position:fixed;bottom:16px;left:50%;z-index:600;background:var(--panel2);border:1.5px solid var(--green);border-radius:8px;padding:8px 18px;font-family:var(--mono);font-size:.75rem;color:var(--green);box-shadow:0 8px 32px rgba(0,0,0,.5);opacity:0;transform:translateX(-50%) translateY(20px);transition:all .3s;pointer-events:none}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}.toast.err{border-color:var(--red);color:var(--red)}
.confirm-overlay{display:none;position:fixed;inset:0;z-index:700;background:rgba(0,0,0,.8);align-items:center;justify-content:center}
.confirm-overlay.open{display:flex}.confirm-box{background:var(--bg3);border:1px solid var(--border2);border-radius:12px;padding:24px;max-width:360px;width:90%;text-align:center}
.confirm-box p{font-size:.9rem;color:var(--text);margin-bottom:8px;line-height:1.5}.confirm-box .sub{font-size:.78rem;color:var(--text2)}
/* â”€â”€ RADIAMÃˆTRES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rd-layout{display:flex;height:calc(100vh - 110px);overflow:hidden}
.rd-sidebar{width:90px;flex-shrink:0;background:var(--bg2);border-right:1px solid var(--border);overflow-y:auto;display:flex;flex-direction:column}
.rd-side-item{padding:10px 6px;text-align:center;cursor:pointer;border-bottom:1px solid var(--border);transition:all .15s;position:relative}
.rd-side-item:hover,.rd-side-item.active{background:var(--panel2)}
.rd-side-item.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--accent)}
.rd-side-icon{font-size:1.3rem;margin-bottom:2px}
.rd-side-label{font-family:var(--mono);font-size:.6rem;color:var(--text2);letter-spacing:.06em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rd-side-status{font-size:.55rem;margin-top:2px;font-weight:700;letter-spacing:.05em}
.rd-side-status.ok{color:var(--green)}.rd-side-status.nc{color:var(--red)}.rd-side-status.wait{color:var(--text3)}.rd-side-status.partial{color:var(--orange)}
.rd-side-add{padding:14px 6px;text-align:center;cursor:pointer;border-top:1px solid var(--border);margin-top:auto;background:rgba(0,212,255,.05);transition:all .15s}
.rd-side-add:hover{background:rgba(0,212,255,.12)}
.rd-config{border-bottom:2px solid var(--border2)!important}
.rd-main{flex:1;overflow-y:auto;padding:12px}
.rd-panel{animation:fadeSlide .2s ease}
@keyframes fadeSlide{from{opacity:0;transform:translateX(10px)}to{opacity:1;transform:translateX(0)}}
.rd-title{font-family:var(--title);font-size:1.1rem;color:var(--accent);letter-spacing:.06em;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.rd-form label{display:block;font-family:var(--mono);font-size:.65rem;color:var(--text3);letter-spacing:.08em;margin:10px 0 4px;text-transform:uppercase}
.rd-form input,.rd-form select,.rd-form textarea{width:100%;height:40px;background:var(--panel);border:1.5px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--body);font-size:.9rem;padding:0 10px;outline:none;transition:border-color .2s}
.rd-form textarea{height:auto;padding:8px 10px}
.rd-form input:focus,.rd-form select:focus,.rd-form textarea:focus{border-color:var(--accent)}
.rd-form input[readonly]{color:var(--text2);background:var(--bg3)}
.rd-section{font-family:var(--title);font-size:.85rem;color:var(--accent);margin:16px 0 6px;padding:6px 10px;background:rgba(0,212,255,.06);border-left:3px solid var(--accent);border-radius:0 4px 4px 0;letter-spacing:.04em}
.rd-radio{display:flex;gap:6px;flex-wrap:wrap}
.rr{padding:6px 12px;background:var(--panel);border:1.5px solid var(--border);border-radius:20px;color:var(--text2);font-size:.78rem;cursor:pointer;transition:all .15s;font-family:var(--body)}
.rr.active{border-color:var(--accent);color:var(--accent);background:rgba(0,212,255,.1)}
.rr[data-v="DÃ©gradÃ©"].active,.rr[data-v="Non-conforme"].active{border-color:var(--red);color:var(--red);background:rgba(255,61,61,.1)}
.rd-mesure-grid{display:grid;grid-template-columns:1fr 100px auto;gap:4px 8px;align-items:center}
.rd-mg-label{font-size:.8rem;color:var(--text2)}
.rd-mg-val input{width:100px;text-align:center;font-family:var(--mono);font-weight:600}
.rd-mg-tol{font-family:var(--mono);font-size:.65rem;color:var(--text3);padding:4px 8px;background:var(--bg3);border-radius:4px;text-align:center}
.rd-mg-tol.ok{color:var(--green);background:rgba(0,230,118,.08)}.rd-mg-tol.ng{color:var(--red);background:rgba(255,61,61,.08)}
.rd-jugement{text-align:center;padding:14px;margin-top:12px;border-radius:8px;font-family:var(--title);font-size:1.2rem;font-weight:700;letter-spacing:.08em;border:2px solid var(--border)}
.rd-jugement.ok{color:var(--green);border-color:var(--green);background:rgba(0,230,118,.08)}
.rd-jugement.ng{color:var(--red);border-color:var(--red);background:rgba(255,61,61,.08)}
.rd-jugement.wait{color:var(--text3)}
.rd-info-row{display:flex;justify-content:space-between;padding:4px 0;font-size:.8rem;color:var(--text2);border-bottom:1px solid var(--border)}
.rd-info-row span:first-child{color:var(--text3)}
.rd-info-row strong{color:var(--accent)}
.rd-banc-info{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:8px 12px;margin-top:8px}
.rd-cst-header{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:8px 12px;margin-bottom:12px;font-size:.8rem;color:var(--text2)}
.rd-stats{font-family:var(--mono);font-size:.75rem;color:var(--text2);padding:10px 0;border-top:1px solid var(--border);margin-top:12px}
.rd-stats .sc{color:var(--green)}.rd-stats .snc{color:var(--red)}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HEADER
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header>
  <div class="htop">
    <div class="logo">â˜¢</div>
    <div>
      <div class="htitle">PORTAIL TECH</div>
      <div class="hsub">BERTIN Â· ZONE CONTRÃ”LÃ‰E</div>
    </div>
    <div class="hright">
      <div class="hdate">Ã‰talons: %%DATE_ETALONS%%</div>
      <div class="hdate">MatÃ©riels: %%DATE_MATERIELS%%</div>
      <div class="hdate">Constats: %%DATE_CONSTATS%%</div>
    </div>
  </div>
  <div class="scanl"></div>
</header>

<!-- INSTALL BANNER (Android uniquement) -->
<div class="install-bar" id="installBar">
  <span>ğŸ“² Installer l'application</span>
  <button class="install-btn" id="installBtn">Installer</button>
  <button class="install-close" id="installClose">âœ•</button>
</div>

<!-- UPDATE BANNER (MAJ dÃ©tectÃ©e) -->
<div class="update-bar" id="updateBar" onclick="applyUpdate()">
  <span>ğŸ”„ Mise Ã  jour disponible</span>
  <button class="update-btn">Actualiser</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TABS NAVIGATION
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tabs">
  <div class="tab active" onclick="go('constats')"><span class="ti">ğŸ“‹</span><div><div class="tt">CONSTATS</div><div class="td">FICHES</div></div><span class="tb" id="bc">%%NB_CONSTATS%%</span></div>
  <div class="tab" onclick="go('etalons')"><span class="ti">âš—ï¸</span><div><div class="tt">Ã‰TALONS</div><div class="td">BASE</div></div><span class="tb" id="be">%%NB_ETALONS%%</span></div>
  <div class="tab" onclick="go('materiels')"><span class="ti">ğŸ”§</span><div><div class="tt">MATÃ‰RIELS</div><div class="td">BASE</div></div><span class="tb" id="bm">%%NB_MATERIELS%%</span></div>
  <div class="tab" onclick="go('calc')"><span class="ti">ğŸ§®</span><div><div class="tt">CALCUL</div><div class="td">VÃ‰RIF</div></div><span class="tb">âš¡</span></div>
  <div class="tab" onclick="go('etiq')"><span class="ti">ğŸ·</span><div><div class="tt">Ã‰TIQUETTES</div><div class="td">IMPRESSION</div></div><span class="tb" id="betiq">0</span></div>
  <div class="tab" onclick="go('radia')"><span class="ti">â˜¢</span><div><div class="tt">RADIAM.</div><div class="td">VÃ‰RIF</div></div><span class="tb" id="bradia">0</span></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE 1 â€” CONSTATS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page active" id="p_constats">
  <div class="tbar"><div class="sbox"><span class="si">ğŸ”</span><input id="sc" placeholder="Rechercher une fiche..." oninput="filtrerC()"></div></div>
  <div class="frow" id="fcats"></div><div class="lcount" id="lcc">â€“</div>
  <div class="cgrid" id="listC"><div class="empty"><div class="ei">ğŸ“‹</div><div class="et">Fiches constats</div></div></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE 2 â€” Ã‰TALONS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="p_etalons">
  <div class="action-bar">
    <button class="btn btn-ghost" onclick="openCatMgr()">âš™ï¸ CatÃ©gories</button>
    <button class="btn btn-green" onclick="exportCSV()">ğŸ“¥ Export CSV</button>
  </div>
  <div class="tbar"><div class="sbox"><span class="si">ğŸ”</span><input id="se" placeholder="ID, isotope, site..." oninput="filtrerE()"></div></div>
  <div class="frow" id="fecats"></div><div class="frow" id="fesites"></div>
  <div class="lcount" id="lce">â€“</div>
  <div class="list" id="listE"></div>
  <div class="fab" onclick="openFormE()">+</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE 3 â€” MATÃ‰RIELS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="p_materiels">
  <div class="tbar"><div class="sbox"><span class="si">ğŸ”</span><input id="sm" placeholder="ID, dÃ©signation, sÃ©rie..." oninput="filtrerM()"></div></div>
  <div class="frow" id="fmcnpe"></div><div class="frow" id="fmctr"></div>
  <div class="lcount" id="lcm">â€“</div>
  <div class="list" id="listM"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE 4 â€” CALCULETTE
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="p_calc">
  <div class="calc-tabs">
    <button class="calc-tab active" onclick="kTab(0,this)">âš¡ SensibilitÃ© / Rendement</button>
    <button class="calc-tab" onclick="kTab(1,this)">â˜¢ ActivitÃ© surfacique</button>
  </div>
  <!-- SUB-TAB 0 -->
  <div class="calc-panel active" id="kp0">
  <div style="padding:14px">
    <div class="calc-section">
      <div class="calc-title">1 Â· Source Ã©talon</div>
      <div class="fg"><label>Source</label><select id="k_src" onchange="kSrcChange()"><option value="">â€” SÃ©lectionner â€”</option></select></div>
      <div class="calc-info" id="k_src_info"></div>
    </div>
    <div class="calc-section">
      <div class="calc-title">2 Â· Comptage (c/s)</div>
      <div style="display:flex;gap:8px">
        <div class="fg" style="flex:1"><label>Comptage 1</label><input id="k_c1" type="number" step="any" placeholder="c/s" oninput="kCalc()"></div>
        <div class="fg" style="flex:1"><label>Comptage 2</label><input id="k_c2" type="number" step="any" placeholder="c/s (optionnel)" oninput="kCalc()"></div>
      </div>
    </div>
    <div class="calc-section">
      <div class="calc-title">3 Â· ActivitÃ© lue (Bq)</div>
      <div style="display:flex;gap:8px">
        <div class="fg" style="flex:1"><label>ActivitÃ© lue 1</label><input id="k_bq1" type="number" step="any" placeholder="Bq" oninput="kCalc()"></div>
        <div class="fg" style="flex:1"><label>ActivitÃ© lue 2</label><input id="k_bq2" type="number" step="any" placeholder="Bq (optionnel)" oninput="kCalc()"></div>
      </div>
    </div>
    <div class="calc-section">
      <div class="calc-title">4 Â· EfficacitÃ© gÃ©omÃ©trique</div>
      <div class="fg"><label>Facteur correctif</label><input id="k_geo" type="number" step="any" value="1" oninput="kCalc()"></div>
    </div>
    <div class="calc-section">
      <div class="calc-title">RÃ©sultats</div>
      <div id="k_results" class="calc-results"></div>
    </div>
    <button class="btn btn-ghost" style="width:100%;margin-top:12px" onclick="kRaz()">ğŸ—‘ Remise Ã  zÃ©ro</button>
  </div>
  </div>
  <!-- SUB-TAB 1 -->
  <div class="calc-panel" id="kp1">
  <div style="padding:14px">
    <div class="calc-section">
      <div class="calc-title">1 Â· Source Ã©talon</div>
      <div class="fg"><label>Source</label><select id="f_src" onchange="fSrcChange()"><option value="">â€” SÃ©lectionner â€”</option></select></div>
      <div class="calc-info" id="f_src_info"></div>
    </div>
    <div class="calc-section">
      <div class="calc-title">2 Â· DonnÃ©es de rÃ©fÃ©rence</div>
      <div style="display:flex;gap:8px">
        <div class="fg" style="flex:1"><label>Flux Ã©mission rÃ©f (p/s)</label><input id="f_flux_ref" type="number" step="any" placeholder="p/s" oninput="fCalc()"></div>
        <div class="fg" style="flex:1"><label>ActivitÃ© rÃ©f (Bq)</label><input id="f_act_ref" type="number" step="any" placeholder="Bq" oninput="fCalc()"></div>
      </div>
      <div class="calc-info" id="f_q_info" style="display:none"></div>
    </div>
    <div class="calc-section">
      <div class="calc-title">3 Â· ActivitÃ© du jour</div>
      <div class="fg"><label>ActivitÃ© du jour (Bq)</label><input id="f_act_jour" type="number" step="any" placeholder="auto si source sÃ©lectionnÃ©e" oninput="fCalc()"></div>
    </div>
    <div class="calc-section">
      <div class="calc-title">RÃ©sultats</div>
      <div id="f_results" class="calc-results"></div>
    </div>
    <button class="btn btn-ghost" style="width:100%;margin-top:12px" onclick="fRaz()">ğŸ—‘ Remise Ã  zÃ©ro</button>
  </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE 5 â€” Ã‰TIQUETTES
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="p_etiq">
  <div style="padding:14px">
    <div class="calc-section">
      <div class="calc-title">Ajouter un matÃ©riel</div>
      <div class="eq-bar">
        <div class="eq-row1">
          <div class="eq-scan" id="eqScanBtn" title="Appui court: 1 scan Â· Appui long: multi-scan">ğŸ“·<span class="eq-scan-hint">long=multi</span></div>
          <input type="text" id="eq_input" placeholder="ID matÃ©riel (ex: BUG026)" list="eq_suggest" oninput="eqAutoComplete()">
          <datalist id="eq_suggest"></datalist>
        </div>
        <div class="eq-row2">
          <select id="eq_type" class="type-c" onchange="eqTypeColor()"><option value="C">âœ“ Conforme</option><option value="NC">âœ— Non Conf.</option></select>
          <div class="eq-add" onclick="eqAdd()" title="Ajouter">â• Ajouter</div>
        </div>
      </div>
      <div class="fg">
        <label style="font-size:.75rem;color:var(--text2)">Date VP (auto depuis base ou manuelle)</label>
        <input type="date" id="eq_date" value="">
      </div>
      <div class="calc-info" id="eq_found" style="display:none"></div>
    </div>
    <div class="calc-section">
      <div class="calc-title">Liste d'impression <span id="eq_count" style="color:var(--green)">0</span> Ã©tiquette(s)</div>
      <div class="eq-list" id="eq_list">
        <div style="text-align:center;color:var(--text3);font-size:.85rem;padding:20px">Scannez ou tapez un ID matÃ©riel pour commencer</div>
      </div>
    </div>
    <div class="calc-section">
      <div class="calc-title">AperÃ§u</div>
      <div class="eq-preview" id="eq_preview"><canvas id="eq_canvas" width="302" height="144"></canvas></div>
    </div>
    <button class="btn btn-primary" style="width:100%;margin-top:8px;height:52px;font-size:1rem" onclick="eqPrint()" id="eq_print_btn" disabled>ğŸ–¨ GÃ©nÃ©rer PDF Ã©tiquettes</button>
    <button class="btn btn-ghost" style="width:100%;margin-top:8px" onclick="eqClear()">ğŸ—‘ Vider la liste</button>
  </div>
</div>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE 6 â€” RADIAMÃˆTRES (VÃ©rification sur site EDF)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="p_radia">
  <!-- Layout: sidebar left (onglets verticaux) + main right (formulaire) -->
  <div class="rd-layout">
    <!-- SIDEBAR GAUCHE : liste des appareils -->
    <div class="rd-sidebar" id="rd_sidebar">
      <div class="rd-side-item rd-config active" onclick="rdShowConfig()">
        <div class="rd-side-icon">âš™ï¸</div>
        <div class="rd-side-label">CONFIG</div>
        <div class="rd-side-status">SESSION</div>
      </div>
      <div id="rd_list"></div>
      <div class="rd-side-add" id="rd_add_btn">
        <div class="rd-side-icon">â•</div>
        <div class="rd-side-label">SCAN</div>
      </div>
    </div>

    <!-- MAIN DROITE : contenu -->
    <div class="rd-main" id="rd_main">

      <!-- â”€â”€ PANNEAU CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="rd-panel" id="rd_config">
        <div class="rd-title">âš™ï¸ Configuration session</div>
        <div class="rd-form">
          <label>OpÃ©rateur</label>
          <input id="rd_operateur" placeholder="Nom complet" oninput="rdSaveConfig()">
          <label>Trigramme</label>
          <input id="rd_trigramme" maxlength="4" placeholder="SBO" oninput="rdSaveConfig()" style="text-transform:uppercase;width:100px">
          <label>ContrÃ´leur technique</label>
          <input id="rd_controleur" placeholder="Nom complet" oninput="rdSaveConfig()">
          <label>Site d'intervention</label>
          <input id="rd_site" placeholder="EDF Saint-Laurent" oninput="rdSaveConfig()">
          <label>NÂ° d'intervention</label>
          <input id="rd_intervention" placeholder="ITV 123456" oninput="rdSaveConfig()">
          <label>Date essai</label>
          <input type="date" id="rd_date" oninput="rdSaveConfig()">
          <label>Banc d'irradiation</label>
          <select id="rd_banc" onchange="rdSelectBanc()">
            <option value="">â€” SÃ©lectionner un banc â€”</option>
          </select>
          <div class="rd-banc-info" id="rd_banc_info" style="display:none">
            <div class="rd-info-row"><span>Distance d1 :</span><strong id="rd_d1">â€“</strong> cm</div>
            <div class="rd-info-row"><span>Distance d2 :</span><strong id="rd_d2">â€“</strong> cm</div>
            <div class="rd-info-row"><span>Localisation :</span><span id="rd_loc">â€“</span></div>
            <div class="rd-info-row"><span>ValiditÃ© banc :</span><span id="rd_val_banc">â€“</span></div>
            <div class="rd-info-row"><span>ModÃ¨le Ã©talon raccordement :</span><span id="rd_model">â€“</span></div>
          </div>
        </div>
        <div class="rd-stats" id="rd_stats"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
          <button class="btn btn-primary" onclick="rdGenAllPDF()" id="rd_btn_pdf" disabled>ğŸ“„ GÃ©nÃ©rer tous les PDF</button>
          <button class="btn btn-accent" onclick="rdExportCSV()" id="rd_btn_csv" disabled>ğŸ“Š Export CSV</button>
          <button class="btn btn-ghost" onclick="rdClearSession()">ğŸ—‘ Vider session</button>
        </div>
      </div>

      <!-- â”€â”€ PANNEAU AJOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="rd-panel" id="rd_add" style="display:none">
        <div class="rd-title">â• Ajouter un radiamÃ¨tre</div>
        <div class="rd-form">
          <label>Code matÃ©riel (scan QR ou saisie)</label>
          <div style="display:flex;gap:8px">
            <input id="rd_scan_input" placeholder="SRIRRRCTDOLG-BEL347..." style="flex:1" list="rd_mat_list" oninput="rdLookup()">
            <button class="btn btn-accent" onclick="rdStartScan()" style="width:52px;font-size:1.3rem;padding:0">ğŸ“·</button>
          </div>
          <datalist id="rd_mat_list"></datalist>
          <div id="rd_lookup_info" style="display:none;margin-top:8px">
            <div class="rd-info-row"><span>Type :</span><strong id="rd_lu_type">â€“</strong></div>
            <div class="rd-info-row"><span>S/N :</span><strong id="rd_lu_sn">â€“</strong></div>
          </div>
          <div style="margin-top:12px">
            <button class="btn btn-primary" onclick="rdAddAppareil()" id="rd_add_confirm" style="width:100%;height:48px" disabled>âœ“ Ajouter Ã  la session</button>
          </div>
        </div>
      </div>

      <!-- â”€â”€ PANNEAU CONSTAT (formulaire par appareil) â”€ -->
      <div class="rd-panel" id="rd_constat" style="display:none">
        <div class="rd-title" id="rd_cst_title">CONSTAT</div>
        <div class="rd-cst-header" id="rd_cst_header"></div>
        <div class="rd-form">
          <!-- Identification -->
          <div class="rd-section">ğŸ“‹ Identification</div>
          <label>Type radiamÃ¨tre</label>
          <input id="rd_c_type" oninput="rdSaveItem()">
          <label>NÂ° sÃ©rie (S/N)</label>
          <input id="rd_c_sn" oninput="rdSaveItem()">
          <label>NÂ° CORIM / GMAO</label>
          <input id="rd_c_corim" oninput="rdSaveItem()">
          <label>NÂ° constat</label>
          <input id="rd_c_numcst" readonly style="color:var(--accent)">

          <!-- Â§5 ContrÃ´les prÃ©liminaires -->
          <div class="rd-section">5. ContrÃ´les prÃ©liminaires</div>
          <label>Aspect gÃ©nÃ©ral</label>
          <div class="rd-radio" id="rd_c_aspect">
            <button class="rr active" onclick="rdRadio(this)" data-v="Correct">Correct</button>
            <button class="rr" onclick="rdRadio(this)" data-v="DÃ©gradÃ©">DÃ©gradÃ©</button>
          </div>
          <label>Ã‰tat de charge batterie</label>
          <div class="rd-radio" id="rd_c_batterie">
            <button class="rr active" onclick="rdRadio(this)" data-v="Conforme">Conforme</button>
            <button class="rr" onclick="rdRadio(this)" data-v="Non-conforme">Non-conforme</button>
          </div>

          <!-- Â§7 ContrÃ´le fonctionnel -->
          <div class="rd-section">7. ContrÃ´le fonctionnel initial</div>
          <label>Son, affichage, rÃ©troÃ©clairage</label>
          <div class="rd-radio" id="rd_c_son">
            <button class="rr active" onclick="rdRadio(this)" data-v="Conforme">Conforme</button>
            <button class="rr" onclick="rdRadio(this)" data-v="Non-conforme">Non-conforme</button>
          </div>
          <label>Reconnaissance sonde</label>
          <div class="rd-radio" id="rd_c_sonde">
            <button class="rr" onclick="rdRadio(this)" data-v="Conforme">Conforme</button>
            <button class="rr" onclick="rdRadio(this)" data-v="Non-conforme">Non-conforme</button>
            <button class="rr active" onclick="rdRadio(this)" data-v="Sans objet">Sans objet</button>
          </div>
          <label>Mise Ã  jour date(s)</label>
          <div class="rd-radio" id="rd_c_maj">
            <button class="rr" onclick="rdRadio(this)" data-v="RÃ©alisÃ©e">RÃ©alisÃ©e</button>
            <button class="rr active" onclick="rdRadio(this)" data-v="Sans objet">Sans objet</button>
          </div>

          <!-- Â§8 VÃ©rification mÃ©trologique -->
          <div class="rd-section">8. VÃ©rification mÃ©trologique</div>
          <div class="rd-mesure-grid">
            <div class="rd-mg-label">Distance d1 (cm)</div>
            <div class="rd-mg-val"><input id="rd_c_d1" type="number" readonly></div>
            <div class="rd-mg-tol">Banc</div>
            <div class="rd-mg-label">DeD d1 (mSv/h)</div>
            <div class="rd-mg-val"><input id="rd_c_ded1" type="number" step="0.1" oninput="rdCalcJugement()" placeholder="ex: 1.0"></div>
            <div class="rd-mg-tol" id="rd_c_ded1_tol">0.7 â€“ 1.3</div>
            <div class="rd-mg-label">Distance d2 (cm)</div>
            <div class="rd-mg-val"><input id="rd_c_d2" type="number" readonly></div>
            <div class="rd-mg-tol">Banc</div>
            <div class="rd-mg-label">DeD d2 (ÂµSv/h)</div>
            <div class="rd-mg-val"><input id="rd_c_ded2" type="number" step="1" oninput="rdCalcJugement()" placeholder="ex: 100"></div>
            <div class="rd-mg-tol" id="rd_c_ded2_tol">63 â€“ 117</div>
          </div>

          <!-- Commentaires -->
          <label>Commentaires</label>
          <textarea id="rd_c_comment" rows="2" oninput="rdSaveItem()" placeholder="Optionnel..."></textarea>

          <!-- Jugement -->
          <div class="rd-jugement" id="rd_c_jugement">â³ EN ATTENTE</div>

          <!-- Actions -->
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn btn-primary" onclick="rdGenOnePDF()" style="flex:1">ğŸ“„ PDF</button>
            <button class="btn btn-ghost" onclick="rdDeleteItem()" style="width:60px;color:var(--red)">ğŸ—‘</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     QR SCANNER MODAL
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="qrModal">
  <div style="font-family:var(--mono);color:var(--accent);font-size:.8rem;margin-bottom:8px;letter-spacing:.1em">SCANNER QR CODE</div>
  <div id="qrMode" style="font-family:var(--mono);font-size:.65rem;color:var(--green);margin-bottom:12px;letter-spacing:.08em"></div>
  <div id="qrReader" style="width:90%;max-width:400px"></div>
  <div id="qrCount" style="font-family:var(--mono);font-size:.9rem;color:var(--green);margin-top:12px"></div>
  <button class="qr-close" onclick="eqScanStop()">âœ• Fermer</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL â€” DÃ©tail
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="mo" id="modal" onclick="if(event.target===this)closeM()"><div class="md"><div class="mh"><h2 id="mt">â€“</h2><button class="mx" onclick="closeM()">âœ•</button></div><div class="mb" id="mbd"></div></div></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL â€” Form Ã©talon
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="mo" id="mform" onclick="if(event.target===this)closeForm()"><div class="md"><div class="mh"><h2 id="mft">Ajouter un Ã©talon</h2><button class="mx" onclick="closeForm()">âœ•</button></div><div class="mb" id="mfb">
  <div class="fg"><label>Identifiant *</label><input id="f_id"></div>
  <div class="fg"><label>CatÃ©gorie *</label><select id="f_cat" onchange="onCatChange()"></select></div>
  <div class="fg"><label>ValiditÃ©</label><input id="f_val" type="date"></div>
  <div class="fg"><label>Site</label><input id="f_site" list="dl_sites"><datalist id="dl_sites"></datalist></div>
  <div class="fg"><label>Localisation</label><input id="f_loc"></div>
  <div id="f_champs_zone"></div>
  <div class="btn-row"><button class="btn btn-primary" onclick="saveE()">ğŸ’¾ Enregistrer</button><button class="btn btn-ghost" onclick="closeForm()">Annuler</button></div>
</div></div></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL â€” CatÃ©gories
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="mo" id="mcats" onclick="if(event.target===this)closeCatMgr()"><div class="md"><div class="mh"><h2>âš™ï¸ CatÃ©gories</h2><button class="mx" onclick="closeCatMgr()">âœ•</button></div><div class="mb" id="mcatsb"></div></div></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL â€” Form catÃ©gorie
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="mo" id="mcatform" onclick="if(event.target===this)closeCatForm()"><div class="md"><div class="mh"><h2 id="mcft">Nouvelle catÃ©gorie</h2><button class="mx" onclick="closeCatForm()">âœ•</button></div><div class="mb">
  <div class="fg"><label>Nom de la catÃ©gorie *</label><input id="cf_nom"></div>
  <div class="fg"><label>Champs spÃ©cifiques</label>
    <div style="display:flex;gap:6px"><input id="cf_new" placeholder="Nom du champ..."><button class="btn btn-ghost" onclick="addCatField()" style="flex-shrink:0">+</button></div>
    <div class="chip-list" id="cf_chips"></div>
  </div>
  <div class="btn-row"><button class="btn btn-primary" onclick="saveCat()">ğŸ’¾ Enregistrer</button><button class="btn btn-ghost" onclick="closeCatForm()">Annuler</button></div>
</div></div></div>

<!-- CONFIRM -->
<div class="confirm-overlay" id="confirmDlg"><div class="confirm-box"><p id="confirmMsg">â€“</p><p class="sub" id="confirmSub"></p><div class="btn-row" style="justify-content:center;margin-top:14px"><button class="btn btn-danger" id="confirmYes">Supprimer</button><button class="btn btn-ghost" onclick="closeConfirm()">Annuler</button></div></div></div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DONNÃ‰ES EMBARQUÃ‰ES (injectÃ©es par export_data.py)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const INIT_ETALONS = %%DATA_ETALONS%%;
const INIT_CATEGORIES = %%DATA_CATEGORIES%%;
const DATA_MATERIELS = %%DATA_MATERIELS%%;
const DATA_CONSTATS = %%DATA_CONSTATS%%;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PWA INSTALL PROMPT (Android uniquement)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let deferredInstallPrompt = null;
window.addEventListener('beforeinstallprompt', function(e) {
  e.preventDefault();
  deferredInstallPrompt = e;
  document.getElementById('installBar').classList.add('show');
});
document.getElementById('installBtn').addEventListener('click', function() {
  if (!deferredInstallPrompt) return;
  deferredInstallPrompt.prompt();
  deferredInstallPrompt.userChoice.then(function(result) {
    deferredInstallPrompt = null;
    document.getElementById('installBar').classList.remove('show');
  });
});
document.getElementById('installClose').addEventListener('click', function() {
  document.getElementById('installBar').classList.remove('show');
  deferredInstallPrompt = null;
});
// Masquer si dÃ©jÃ  installÃ©e (standalone)
if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
  document.getElementById('installBar').style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE â€” localStorage wrapper
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LS = {
  get(k, def) { try { const v=localStorage.getItem('pt_'+k); return v?JSON.parse(v):def; } catch { return def; } },
  set(k, v) { try { localStorage.setItem('pt_'+k, JSON.stringify(v)); } catch {} }
};

// Init: si premier lancement, copier donnÃ©es embarquÃ©es
if (!LS.get('init', false)) {
  LS.set('etalons', INIT_ETALONS);
  LS.set('categories', INIT_CATEGORIES);
  LS.set('init', true);
}

function getEtalons() { return LS.get('etalons', INIT_ETALONS); }
function setEtalons(arr) { LS.set('etalons', arr); }
function getCats() { return LS.get('categories', INIT_CATEGORIES); }
function setCats(arr) { LS.set('categories', arr); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DÃ‰CROISSANCE RADIOACTIVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseDate(s){if(!s)return null;s=String(s).trim();if(s.includes('-')&&s.length>=10){const d=new Date(s);return isNaN(d)?null:d;}const p=s.split('/');if(p.length===3){let y=parseInt(p[2]);if(y<100)y+=2000;return new Date(y,parseInt(p[1])-1,parseInt(p[0]));}return null;}
function calcActivite(src){if(!src||!src.tv||!src.a0||!src.dr)return null;const d0=parseDate(src.dr);if(!d0)return null;const j=(new Date()-d0)/(864e5);if(j<0)return src.a0;return src.a0*Math.exp(-Math.LN2/src.tv*j);}
function fmtAct(v){if(v==null)return'â€“';return v.toFixed(2)+' Bq';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION & UTILITAIRES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TAB_MAP = {constats:0,etalons:1,materiels:2,calc:3,etiq:4,radia:5};
function go(p){document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));document.getElementById('p_'+p).classList.add('active');document.querySelectorAll('.tab')[TAB_MAP[p]].classList.add('active');}
function esc(s){return s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'):'';}
function dfr(s){if(!s)return'â€“';try{const p=s.split('-');return p.length>=3?p[2]+'/'+p[1]+'/'+p[0]:s}catch{return s;}}
const VB={valide:['vv','VALIDE'],permanent:['vp','âˆ PERMANENT'],bientot:['vb2','âš  BIENTÃ”T'],expire:['ve','âœ— EXPIRÃ‰'],inconnu:['vi','â€“']};
function buildFilters(items,key,cid,setter){const vals=[...new Set(items.map(i=>i[key]).filter(Boolean))].sort();const el=document.getElementById(cid);el.innerHTML='<button class="fbtn active" onclick="'+setter+'(\'\',this)">Tout</button>';vals.forEach(v=>{el.innerHTML+='<button class="fbtn" onclick="'+setter+'(\''+esc(v).replace(/'/g,"\\'")+'\',this)">'+esc(v)+'</button>';});}
function activateBtn(b){b.parentElement.querySelectorAll('.fbtn').forEach(x=>x.classList.remove('active'));b.classList.add('active');}
function toast(m,err){const e=document.getElementById('toast');e.textContent=m;e.className='toast show'+(err?' err':'');clearTimeout(e._t);e._t=setTimeout(()=>e.className='toast',3000);}
function showToast(m,type){toast(m,type==='err');}
function dr(l,v,a){return'<div class="dr"><span class="dl">'+esc(l)+'</span><span class="dv'+(a?' ac':'')+'">'+esc(v||'â€“')+'</span></div>';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let fCcat='';
function setCcat(c,b){fCcat=c;activateBtn(b);filtrerC();}
function filtrerC(){const q=document.getElementById('sc').value.toLowerCase();renderConstats(DATA_CONSTATS.filter(c=>{if(fCcat&&c.c!==fCcat)return false;if(!q)return true;return(c.t+c.d+c.c).toLowerCase().includes(q);}));}
function renderConstats(items=DATA_CONSTATS){document.getElementById('bc').textContent=items.length||'â€“';document.getElementById('lcc').innerHTML='<span>'+items.length+'</span> fiche'+(items.length>1?'s':'');if(!items.length){document.getElementById('listC').innerHTML='<div class="empty"><div class="ei">ğŸ“‹</div><div class="et">Aucune fiche</div></div>';return;}document.getElementById('listC').innerHTML=items.map((c,i)=>'<div class="cc" onclick="ouvrirFiche(\''+esc(c.url).replace(/'/g,"\\'")+'\')" style="animation-delay:'+i*50+'ms;cursor:pointer"><div class="ci">'+c.i+'</div><div class="ct">'+esc(c.t)+'</div><div class="cd">'+esc(c.d)+'</div><div class="ck">'+esc(c.c)+'</div></div>').join('');}
function ouvrirFiche(url){
  try{const src=getEtalons().filter(e=>e.cat==='Source').map(e=>{const iso=(e.ch||[]).find(c=>c.l==='Isotope');return{id:e.id,iso:iso?iso.v:'',src:e.src||{}};});window.name='PT_SRC:'+JSON.stringify(src);}catch(e){}
  const base=window.location.href.substring(0,window.location.href.lastIndexOf('/')+1);
  window.location.href=base+url;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ã‰TALONS â€” Liste & recherche
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let fEcat='',fEsite='';
function setEcat(c,b){fEcat=c;activateBtn(b);filtrerE();}
function setEsite(s,b){fEsite=s;activateBtn(b);filtrerE();}
function filtrerE(){const q=document.getElementById('se').value.toLowerCase();const all=getEtalons();const f=all.filter(e=>{if(fEcat&&e.cat!==fEcat)return false;if(fEsite&&e.site!==fEsite)return false;if(!q)return true;return[e.id,e.cat,e.site,e.loc,...(e.ch||[]).map(c=>c.l+' '+c.v)].join(' ').toLowerCase().includes(q);});renderEtalons(f);}
function refreshE(){const all=getEtalons();buildFilters(all,'cat','fecats','setEcat');buildFilters(all,'site','fesites','setEsite');document.getElementById('be').textContent=all.length;filtrerE();}
function renderEtalons(items){document.getElementById('lce').innerHTML='<span>'+items.length+'</span> Ã©talon'+(items.length>1?'s':'');const el=document.getElementById('listE');if(!items.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ”</div><div class="et">Aucun rÃ©sultat</div></div>';return;}
el.innerHTML=items.map((e,i)=>{const b=VB[e.sv]||VB.inconnu;const vd=e.val&&!e.val.startsWith('3000')?dfr(e.val):'';const ch=(e.ch||[]).slice(0,4).map(c=>'<span class="ctag"><i>'+esc(c.l)+':</i> '+esc(c.v)+'</span>').join('');let actTag='';const act=calcActivite(e.src);if(act!==null)actTag='<span class="ctag act">âš› '+fmtAct(act)+'</span>';const loc=e._local?'<span class="badge-local">LOCAL</span>':'';const ce=getCertificat(e.id)?'<span class="badge-ce" title="Certificat disponible">ğŸ“„</span>':'';return'<div class="ec" style="animation-delay:'+Math.min(i*30,500)+'ms" onclick="detailE(\''+esc(e.id).replace(/'/g,"\\'")+'\')">'+'<div class="r1"><span class="eid">'+esc(e.id)+'</span><span class="ecat">'+esc(e.cat)+'</span>'+loc+ce+'<span class="vb '+b[0]+'">'+b[1]+(vd?' Â· '+vd:'')+'</span></div>'+'<div class="r2"><b>'+esc(e.site)+'</b> â€º '+esc(e.loc)+'</div>'+(ch||actTag?'<div class="r3">'+actTag+ch+'</div>':'')+'</div>';}).join('');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ã‰TALONS â€” DÃ©tail + Modifier/Supprimer
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function detailE(id){const e=getEtalons().find(x=>x.id===id);if(!e)return;document.getElementById('mt').textContent='Ã‰talon '+e.id;const b=VB[e.sv]||VB.inconnu;
let h='<div class="ds"><h3>Informations gÃ©nÃ©rales</h3>'+dr('Identifiant',e.id,1)+dr('CatÃ©gorie',e.cat)+dr('Site',e.site)+dr('Localisation',e.loc)+dr('ValiditÃ©',e.val&&e.val.startsWith('3000')?'Permanent':dfr(e.val))+'<div class="dr"><span class="dl">Statut</span><span class="vb '+b[0]+'">'+b[1]+'</span></div></div>';
if(e.ch&&e.ch.length)h+='<div class="ds"><h3>CaractÃ©ristiques</h3>'+e.ch.map(c=>dr(c.l,c.v)).join('')+'</div>';
const act=calcActivite(e.src);if(act!==null)h+='<div class="ds"><h3>âš› ActivitÃ© temps rÃ©el</h3><div class="dr"><span class="dl">ActivitÃ© du jour</span><span class="dv ac" style="font-size:1rem;font-weight:700">'+fmtAct(act)+'</span></div></div>';
if(e.dc||e.uc)h+='<div class="ds"><h3>TraÃ§abilitÃ©</h3>'+(e.dc?dr('CrÃ©Ã© le',dfr(e.dc)):'')+(e.uc?dr('CrÃ©Ã© par',e.uc):'')+(e.dm?dr('ModifiÃ© le',dfr(e.dm)):'')+(e.um?dr('ModifiÃ© par',e.um):'')+'</div>';
const ceId=e.id.replace(/[^a-zA-Z0-9_-]/g,'_');
const hasCE=getCertificat(e.id);
h+='<div class="ds"><h3>ğŸ“„ Certificat d\'Ã©talonnage</h3>';
if(hasCE){h+='<button class="btn btn-primary" style="width:100%;margin-bottom:8px" onclick="ouvrirCE(\''+esc(e.id).replace(/'/g,"\\'")+'\')">ğŸ“„ Ouvrir le certificat</button>';}
h+='<div style="display:flex;gap:8px"><button class="btn '+(hasCE?'btn-ghost':'btn-primary')+'" style="flex:1" onclick="document.getElementById(\'ce_file_'+ceId+'\').click()">'+(hasCE?'ğŸ”„ Remplacer':'â• Ajouter un certificat')+'</button>';
if(hasCE)h+='<button class="btn btn-danger" style="flex-shrink:0;width:46px" onclick="supprimerCE(\''+esc(e.id).replace(/'/g,"\\'")+'\');closeM();detailE(\''+esc(e.id).replace(/'/g,"\\'")+'\')">ğŸ—‘</button>';
h+='</div><input type="file" id="ce_file_'+ceId+'" accept=".pdf" style="display:none" onchange="chargerCE(\''+esc(e.id).replace(/'/g,"\\'")+'\',this)"></div>';
if(e._local){h+='<div class="btn-row"><button class="btn btn-primary" onclick="closeM();editE(\''+esc(e.id).replace(/'/g,"\\'")+'\')">âœï¸ Modifier</button><button class="btn btn-danger" onclick="closeM();confirmDeleteE(\''+esc(e.id).replace(/'/g,"\\'")+'\')">ğŸ—‘ Supprimer</button></div>';
}else{h+='<div style="font-family:var(--mono);font-size:.65rem;color:var(--text3);margin-top:14px;text-align:center">ğŸ”’ Ã‰talon importÃ© â€” modification non autorisÃ©e</div>';}
document.getElementById('mbd').innerHTML=h;document.getElementById('modal').classList.add('open');}
function closeM(){document.getElementById('modal').classList.remove('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CERTIFICATS D'Ã‰TALONNAGE (localStorage pt_certificats)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getCertificats(){try{return JSON.parse(localStorage.getItem('pt_certificats')||'{}');}catch(e){return {};}}
function getCertificat(id){return getCertificats()[id]||null;}
function setCertificat(id,b64){const c=getCertificats();c[id]=b64;localStorage.setItem('pt_certificats',JSON.stringify(c));}
function supprimerCE(id){const c=getCertificats();delete c[id];localStorage.setItem('pt_certificats',JSON.stringify(c));showToast('Certificat supprimÃ©');}
function chargerCE(id,input){
  const file=input.files&&input.files[0];
  if(!file)return;
  if(!file.name.toLowerCase().endsWith('.pdf')){showToast('Format PDF requis','err');return;}
  if(file.size>10*1024*1024){showToast('Fichier trop volumineux (max 10 Mo)','err');return;}
  const reader=new FileReader();
  reader.onload=function(){setCertificat(id,reader.result);showToast('âœ“ Certificat ajoutÃ© pour '+id);closeM();detailE(id);};
  reader.onerror=function(){showToast('Erreur lecture fichier','err');};
  reader.readAsDataURL(file);
}
function ouvrirCE(id){
  const b64=getCertificat(id);
  if(!b64){showToast('Aucun certificat','err');return;}
  const win=window.open('','_blank');
  if(!win){showToast('Popup bloquÃ©e','err');return;}
  win.document.write('<html><head><title>CE '+id+'</title></head><body style="margin:0"><embed src="'+b64+'" type="application/pdf" width="100%" height="100%" style="position:fixed;inset:0"></body></html>');
  win.document.close();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ã‰TALONS â€” Formulaire ajout/modif
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editingId=null;
function openFormE(id){editingId=id||null;const e=id?getEtalons().find(x=>x.id===id):null;document.getElementById('mft').textContent=e?'Modifier Ã©talon':'Nouvel Ã©talon';
const sel=document.getElementById('f_cat');sel.innerHTML=getCats().map(c=>'<option value="'+esc(c.nom)+'">'+esc(c.nom)+'</option>').join('');
const sites=[...new Set(getEtalons().map(x=>x.site).filter(Boolean))].sort();document.getElementById('dl_sites').innerHTML=sites.map(s=>'<option value="'+esc(s)+'">').join('');
if(e){document.getElementById('f_id').value=e.id;sel.value=e.cat;document.getElementById('f_val').value=e.val?e.val.substring(0,10):'';document.getElementById('f_site').value=e.site;document.getElementById('f_loc').value=e.loc;}
else{document.getElementById('f_id').value='';document.getElementById('f_val').value='';document.getElementById('f_site').value='';document.getElementById('f_loc').value='';}
onCatChange(e);document.getElementById('mform').classList.add('open');}
function closeForm(){document.getElementById('mform').classList.remove('open');editingId=null;}
function editE(id){openFormE(id);}

function onCatChange(existingE){const catNom=document.getElementById('f_cat').value;const cat=getCats().find(c=>c.nom===catNom);const zone=document.getElementById('f_champs_zone');if(!cat||!cat.champs||!cat.champs.length){zone.innerHTML='';return;}
zone.innerHTML=cat.champs.map((ch,i)=>'<div class="fg"><label>'+esc(ch)+'</label><input id="f_ch_'+i+'" data-label="'+esc(ch)+'"></div>').join('');
if(existingE&&existingE.ch){existingE.ch.forEach(c=>{const idx=cat.champs.indexOf(c.l);if(idx>=0){const inp=document.getElementById('f_ch_'+idx);if(inp)inp.value=c.v;}});}}

function saveE(){const id=document.getElementById('f_id').value.trim();const cat=document.getElementById('f_cat').value;if(!id||!cat){toast('ID et catÃ©gorie requis',true);return;}
const catDef=getCats().find(c=>c.nom===cat);const champs=[];if(catDef&&catDef.champs){catDef.champs.forEach((ch,i)=>{const inp=document.getElementById('f_ch_'+i);if(inp&&inp.value.trim())champs.push({l:ch,v:inp.value.trim()});});}
const valStr=document.getElementById('f_val').value;let sv='inconnu';if(valStr){const d=new Date(valStr);const delta=Math.floor((d-new Date())/(864e5));if(d.getFullYear()>=2999)sv='permanent';else if(delta<0)sv='expire';else if(delta<=90)sv='bientot';else sv='valide';}
let src={};if(cat==='Source'&&catDef){const tv=champs.find(c=>c.l==='Demi-vie (jours)');const a0=champs.find(c=>c.l==='ActivitÃ© ref (Bq)');const dref=champs.find(c=>c.l==='Date rÃ©fÃ©rence');if(tv)try{src.tv=parseFloat(tv.v.replace(',','.'));}catch{}if(a0)try{src.a0=parseFloat(a0.v.replace(',','.'));}catch{}if(dref)src.dr=dref.v;}
const obj={id,cat,val:valStr,sv,site:document.getElementById('f_site').value.trim(),loc:document.getElementById('f_loc').value.trim(),ch:champs,src,dc:new Date().toISOString().substring(0,10),dm:'',uc:'Portail',um:'',_local:true};
let all=getEtalons();if(editingId){const idx=all.findIndex(x=>x.id===editingId);if(idx>=0){obj.dc=all[idx].dc||obj.dc;obj.dm=new Date().toISOString().substring(0,10);obj.um='Portail';all[idx]=obj;}else all.push(obj);}
else{if(all.find(x=>x.id===id)){toast('ID dÃ©jÃ  existant !',true);return;}all.push(obj);}
setEtalons(all);closeForm();refreshE();toast(editingId?'Ã‰talon modifiÃ© âœ“':'Ã‰talon ajoutÃ© âœ“');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ã‰TALONS â€” Suppression
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pendingDeleteId=null;
function confirmDeleteE(id){pendingDeleteId=id;document.getElementById('confirmMsg').textContent='Supprimer l\'Ã©talon '+id+' ?';document.getElementById('confirmSub').textContent='Cette action est irrÃ©versible.';document.getElementById('confirmYes').onclick=()=>{deleteE();closeConfirm();};document.getElementById('confirmDlg').classList.add('open');}
function deleteE(){if(!pendingDeleteId)return;let all=getEtalons().filter(x=>x.id!==pendingDeleteId);setEtalons(all);refreshE();toast('Ã‰talon supprimÃ©');pendingDeleteId=null;}
function closeConfirm(){document.getElementById('confirmDlg').classList.remove('open');pendingDeleteId=null;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV(){const all=getEtalons();const cats=getCats();const maxCh=Math.max(...cats.map(c=>c.champs?c.champs.length:0),5);
let headers=['ID','Categorie','Validite','Site','Localisation'];for(let i=0;i<maxCh;i++)headers.push('Champ'+(i+1));
headers.push('DateCreation','DateModification','UtilisateurCreation','UtilisateurModification');
const sep=';';const rows=[headers.join(sep)];
all.forEach(e=>{const cat=cats.find(c=>c.nom===e.cat);const chVals=[];for(let i=0;i<maxCh;i++){const label=cat&&cat.champs&&cat.champs[i]?cat.champs[i]:'';const found=(e.ch||[]).find(c=>c.l===label);chVals.push(found?found.v:'');}
const row=[e.id,e.cat,e.val||'',e.site,e.loc,...chVals,e.dc||'',e.dm||'',e.uc||'',e.um||''];rows.push(row.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(sep));});
const bom='\uFEFF';const blob=new Blob([bom+rows.join('\r\n')],{type:'text/csv;charset=utf-8'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='etalons_export_'+new Date().toISOString().slice(0,10)+'.csv';a.click();toast('CSV exportÃ© âœ“');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GESTION CATÃ‰GORIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCatMgr(){renderCatList();document.getElementById('mcats').classList.add('open');}
function closeCatMgr(){document.getElementById('mcats').classList.remove('open');}
function renderCatList(){const cats=getCats();const el=document.getElementById('mcatsb');const all=getEtalons();
el.innerHTML=cats.map((c,i)=>{const nb=all.filter(e=>e.cat===c.nom).length;return'<div style="background:var(--panel);border:1.5px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px">'+'<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><b style="color:var(--accent);flex:1">'+esc(c.nom)+'</b><span style="font-family:var(--mono);font-size:.65rem;color:var(--text3)">'+nb+' Ã©talon'+(nb>1?'s':'')+'</span>'+'<button class="btn btn-ghost" style="height:28px;padding:0 10px;font-size:.72rem" onclick="editCat('+i+')">âœï¸</button>'+'<button class="btn btn-danger" style="height:28px;padding:0 10px;font-size:.72rem" onclick="confirmDeleteCat('+i+')">ğŸ—‘</button></div>'+(c.champs&&c.champs.length?'<div class="chip-list">'+c.champs.map(ch=>'<span class="chip">'+esc(ch)+'</span>').join('')+'</div>':'<span style="font-size:.72rem;color:var(--text3)">Aucun champ spÃ©cifique</span>')+'</div>';}).join('')+'<button class="btn btn-primary" style="width:100%;margin-top:12px" onclick="newCat()">+ Nouvelle catÃ©gorie</button>';}

let editCatIdx=null,catFields=[];
function newCat(){editCatIdx=null;catFields=[];document.getElementById('mcft').textContent='Nouvelle catÃ©gorie';document.getElementById('cf_nom').value='';renderCatChips();document.getElementById('mcatform').classList.add('open');}
function editCat(i){const c=getCats()[i];editCatIdx=i;catFields=[...(c.champs||[])];document.getElementById('mcft').textContent='Modifier: '+c.nom;document.getElementById('cf_nom').value=c.nom;renderCatChips();document.getElementById('mcatform').classList.add('open');}
function closeCatForm(){document.getElementById('mcatform').classList.remove('open');}
function addCatField(){const inp=document.getElementById('cf_new');const v=inp.value.trim();if(!v)return;catFields.push(v);inp.value='';renderCatChips();}
function removeCatField(i){catFields.splice(i,1);renderCatChips();}
function renderCatChips(){document.getElementById('cf_chips').innerHTML=catFields.map((f,i)=>'<span class="chip">'+esc(f)+' <span class="chip-x" onclick="removeCatField('+i+')">âœ•</span></span>').join('');}
function saveCat(){const nom=document.getElementById('cf_nom').value.trim();if(!nom){toast('Nom requis',true);return;}
let cats=getCats();if(editCatIdx!==null){const oldNom=cats[editCatIdx].nom;cats[editCatIdx]={nom,champs:[...catFields]};if(oldNom!==nom){let all=getEtalons();all.forEach(e=>{if(e.cat===oldNom)e.cat=nom;});setEtalons(all);}}
else{if(cats.find(c=>c.nom===nom)){toast('CatÃ©gorie existante',true);return;}cats.push({nom,champs:[...catFields]});}
setCats(cats);closeCatForm();renderCatList();refreshE();toast('CatÃ©gorie enregistrÃ©e âœ“');}
function confirmDeleteCat(i){const c=getCats()[i];const nb=getEtalons().filter(e=>e.cat===c.nom).length;document.getElementById('confirmMsg').textContent='Supprimer la catÃ©gorie "'+c.nom+'" ?';document.getElementById('confirmSub').textContent=nb?'âš  '+nb+' Ã©talon(s) utilisent cette catÃ©gorie !':'Aucun Ã©talon n\'utilise cette catÃ©gorie.';document.getElementById('confirmYes').onclick=()=>{let cats=getCats();cats.splice(i,1);setCats(cats);closeConfirm();renderCatList();refreshE();toast('CatÃ©gorie supprimÃ©e');};document.getElementById('confirmDlg').classList.add('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MATÃ‰RIELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let fMcnpe='',fMctr='';
function setMcnpe(c,b){fMcnpe=c;activateBtn(b);filtrerM();}
function setMctr(c,b){fMctr=c;activateBtn(b);filtrerM();}
function filtrerM(){const q=document.getElementById('sm').value.toLowerCase();renderMateriels(DATA_MATERIELS.filter(m=>{if(fMcnpe&&m.cnpe!==fMcnpe)return false;if(fMctr&&m.ctr!==fMctr)return false;if(!q)return true;return[m.id,m.des,m.ns,m.nc,m.cnpe,m.loc,m.ctr,m.obs].join(' ').toLowerCase().includes(q);}));}
function renderMateriels(items=DATA_MATERIELS){document.getElementById('lcm').innerHTML='<span>'+items.length+'</span> matÃ©riel'+(items.length>1?'s':'');const el=document.getElementById('listM');if(!items.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ”</div><div class="et">Aucun rÃ©sultat</div></div>';return;}
const MAX=200;const aff=items.slice(0,MAX);el.innerHTML=aff.map((m,i)=>{const b=VB[m.sv]||VB.inconnu;const vd=m.val?dfr(m.val):'';return'<div class="mc" style="animation-delay:'+Math.min(i*15,400)+'ms" onclick="detailM(\''+esc(m.id).replace(/'/g,"\\'")+'\')">'+'<div class="r1"><span class="mid">'+esc(m.id)+'</span>'+(m.ctr?'<span class="mctr">'+esc(m.ctr)+'</span>':'')+'<span class="vb '+b[0]+'">'+b[1]+(vd?' '+vd:'')+'</span></div>'+'<div class="r2">'+esc(m.des)+'</div>'+'<div class="r3">'+(m.cnpe?esc(m.cnpe):'')+(m.loc?' â€º '+esc(m.loc):'')+(m.ns?' Â· S/N: '+esc(m.ns):'')+'</div></div>';}).join('')+(items.length>MAX?'<div class="empty"><div class="et">'+(items.length-MAX)+' rÃ©sultats suppl.</div></div>':'');}
function detailM(id){const m=DATA_MATERIELS.find(x=>x.id===id);if(!m)return;document.getElementById('mt').textContent=m.id;const b=VB[m.sv]||VB.inconnu;let h='<div class="ds"><h3>Identification</h3>'+dr('ID',m.id,1)+dr('DÃ©signation',m.des)+dr('NÂ° SÃ©rie',m.ns)+dr('NÂ° Corim',m.nc)+'</div>';h+='<div class="ds"><h3>Localisation</h3>'+dr('CNPE',m.cnpe)+dr('Localisation',m.loc)+dr('Contrat',m.ctr)+'</div>';h+='<div class="ds"><h3>ValiditÃ©</h3>'+dr('Date VP',dfr(m.dvp))+dr('ValiditÃ©',dfr(m.val))+'<div class="dr"><span class="dl">Statut</span><span class="vb '+b[0]+'">'+b[1]+'</span></div></div>';if(m.obs)h+='<div class="ds"><h3>Observations</h3><div class="dobs">'+esc(m.obs)+'</div></div>';document.getElementById('mbd').innerHTML=h;document.getElementById('modal').classList.add('open');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALCULETTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCalc(){
  ['k_src','f_src'].forEach(selId=>{
    const sel=document.getElementById(selId);
    sel.innerHTML='<option value="">â€” SÃ©lectionner une source â€”</option>';
    getEtalons().filter(e=>e.cat==='Source').forEach(e=>{
      const act=calcActivite(e.src);
      const iso=(e.ch||[]).find(c=>c.l==='Isotope');
      const typ=(e.ch||[]).find(c=>c.l==='Type EDF');
      const label=e.id+(iso?' Â· '+iso.v:'')+(typ?' Â· '+typ.v:'')+(act?' Â· '+fmtAct(act):'');
      sel.innerHTML+='<option value="'+esc(e.id)+'">'+esc(label)+'</option>';
    });
  });
}

let kSource=null;
function kSrcChange(){
  const id=document.getElementById('k_src').value;
  const info=document.getElementById('k_src_info');
  if(!id){kSource=null;info.innerHTML='';kCalc();return;}
  const e=getEtalons().find(x=>x.id===id);
  if(!e){kSource=null;info.innerHTML='';kCalc();return;}
  kSource=e;
  const act=calcActivite(e.src);const iso=(e.ch||[]).find(c=>c.l==='Isotope');const typ=(e.ch||[]).find(c=>c.l==='Type EDF');const aref=(e.ch||[]).find(c=>c.l==='ActivitÃ© ref (Bq)');const dref=(e.ch||[]).find(c=>c.l==='Date rÃ©fÃ©rence');
  info.innerHTML='<b>'+esc(e.id)+'</b>'+(iso?' â€” '+esc(iso.v):'')+(typ?' â€” '+esc(typ.v):'')+(dref?'<br>Date rÃ©f: '+esc(dref.v):'')+(aref?'  Â·  Aâ‚€: '+esc(aref.v)+' Bq':'')+(act!==null?'<br><span class="ai">âš› ActivitÃ© du jour: '+fmtAct(act)+'</span>':'');
  kCalc();
}

let fSource=null;
function fSrcChange(){
  const id=document.getElementById('f_src').value;const info=document.getElementById('f_src_info');
  if(!id){fSource=null;info.innerHTML='';fCalc();return;}
  const e=getEtalons().find(x=>x.id===id);
  if(!e){fSource=null;info.innerHTML='';fCalc();return;}
  fSource=e;
  const act=calcActivite(e.src);const iso=(e.ch||[]).find(c=>c.l==='Isotope');const typ=(e.ch||[]).find(c=>c.l==='Type EDF');const aref=(e.ch||[]).find(c=>c.l==='ActivitÃ© ref (Bq)');const dref=(e.ch||[]).find(c=>c.l==='Date rÃ©fÃ©rence');
  info.innerHTML='<b>'+esc(e.id)+'</b>'+(iso?' â€” '+esc(iso.v):'')+(typ?' â€” '+esc(typ.v):'')+(dref?'<br>Date rÃ©f: '+esc(dref.v):'')+(aref?'  Â·  Aâ‚€: '+esc(aref.v)+' Bq':'')+(act!==null?'<br><span class="ai">âš› ActivitÃ© du jour: '+fmtAct(act)+'</span>':'');
  if(act!==null) document.getElementById('f_act_jour').value=act.toFixed(2);
  if(aref) document.getElementById('f_act_ref').value=aref.v;
  fCalc();
}

function kCalc(){
  const c1=parseFloat(document.getElementById('k_c1').value);const c2=parseFloat(document.getElementById('k_c2').value);
  const bq1=parseFloat(document.getElementById('k_bq1').value);const bq2=parseFloat(document.getElementById('k_bq2').value);
  const geo=parseFloat(document.getElementById('k_geo').value)||1;const actSrc=kSource?calcActivite(kSource.src):null;
  const res=document.getElementById('k_results');let h='';
  let moy=null;
  if(!isNaN(c1)&&!isNaN(c2)){moy=(c1+c2)/2;h+=kRow('Taux moyen',moy.toFixed(2),'c/s',null);}
  else if(!isNaN(c1)){moy=c1;h+=kRow('Taux comptage',moy.toFixed(2),'c/s',null);}
  if(!isNaN(c1)&&!isNaN(c2)&&moy>0){const ecart=Math.abs(c1-c2)/moy*100;h+=kRow('Ã‰cart relatif',ecart.toFixed(1),'%',null);}
  if(moy!==null&&actSrc!==null&&geo){const sens=moy/(actSrc*geo);h+=kRow('SensibilitÃ© â¶â°Co',sens.toFixed(4),'c/s/Bq',null);}
  if(!isNaN(bq1)&&actSrc!==null){h+=kRow('Rapport dÃ©tecteur 1',(bq1/actSrc).toFixed(4),'',null);}
  if(!isNaN(bq2)&&actSrc!==null){h+=kRow('Rapport dÃ©tecteur 2',(bq2/actSrc).toFixed(4),'',null);}
  if(!h)h='<div style="text-align:center;color:var(--text3);font-size:.85rem;padding:30px">Renseignez les valeurs ci-dessus</div>';
  res.innerHTML=h;
}
function kRow(label,val,unit,ok){
  const cls=ok===null?'na':(ok?'ok':'ko');
  const badge=ok===null?'':(ok?'<span class="kb">âœ“ CONFORME</span>':'<span class="kb">âœ— NON CONFORME</span>');
  return'<div class="kr '+cls+'"><div class="kl">'+esc(label)+'</div><div class="kv">'+esc(val)+'<span class="ku">'+esc(unit||'')+'</span>'+badge+'</div></div>';
}
function kRaz(){['k_c1','k_c2','k_bq1','k_bq2'].forEach(id=>document.getElementById(id).value='');document.getElementById('k_geo').value='1';document.getElementById('k_src').value='';document.getElementById('k_src_info').innerHTML='';document.getElementById('k_results').innerHTML='';kSource=null;}
function kTab(idx,btn){document.querySelectorAll('.calc-panel').forEach((p,i)=>p.classList.toggle('active',i===idx));document.querySelectorAll('.calc-tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FLUX D'Ã‰MISSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fCalc(){
  const fluxRef=parseFloat(document.getElementById('f_flux_ref').value);const actRef=parseFloat(document.getElementById('f_act_ref').value);const actJour=parseFloat(document.getElementById('f_act_jour').value);
  const qInfo=document.getElementById('f_q_info');const res=document.getElementById('f_results');
  let h='';let q=null;
  if(!isNaN(fluxRef)&&!isNaN(actRef)&&actRef>0){q=fluxRef/actRef;qInfo.innerHTML='<b>q</b> = flux rÃ©f / activitÃ© rÃ©f = <b>'+q.toFixed(4)+'</b> p/s/Bq';qInfo.style.display='block';}else{qInfo.innerHTML='';qInfo.style.display='none';}
  if(q!==null&&!isNaN(actJour)&&q>0){const fluxJour=actJour/q;h+=kRow('Flux du jour',fluxJour.toFixed(2),'p/s',null);h+=kRow('RÃ©ponse Î²',(fluxJour/15).toFixed(2),'Bq/cmÂ²',null);h+=kRow('RÃ©ponse Î±',(fluxJour/16.5).toFixed(2),'Bq/cmÂ²',null);}
  if(!h)h='<div style="text-align:center;color:var(--text3);font-size:.85rem;padding:30px">Renseignez les donnÃ©es de rÃ©fÃ©rence et l\'activitÃ© du jour</div>';
  res.innerHTML=h;
}
function fRaz(){['f_flux_ref','f_act_ref','f_act_jour'].forEach(id=>document.getElementById(id).value='');document.getElementById('f_src').value='';document.getElementById('f_src_info').innerHTML='';document.getElementById('f_q_info').innerHTML='';document.getElementById('f_q_info').style.display='none';document.getElementById('f_results').innerHTML='';fSource=null;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ã‰TIQUETTES â€” Scan QR + Liste + Impression
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MOIS_FR=['JAN','FÃ‰V','MAR','AVR','MAI','JUN','JUL','AOÃ›','SEP','OCT','NOV','DÃ‰C'];
function fmtDateEtiq(d){if(!d)return'â€”';const dt=typeof d==='string'?new Date(d):d;if(isNaN(dt))return'â€”';return String(dt.getDate()).padStart(2,'0')+' '+MOIS_FR[dt.getMonth()]+' '+String(dt.getFullYear()).slice(-2);}
function addMonths(d,n){const r=new Date(d);r.setMonth(r.getMonth()+n);return r;}

let eqItems=[];
let qrScanner=null;
const ETIQ_IMG_C='%%ETIQ_IMG_C%%';
const ETIQ_IMG_NC='%%ETIQ_IMG_NC%%';

function eqParseId(raw){if(!raw)return raw;const idx=raw.lastIndexOf('-');return idx>=0?raw.substring(idx+1):raw;}
function eqTypeColor(){var s=document.getElementById('eq_type');s.className=s.value==='C'?'type-c':'type-nc';}
function eqAutoComplete(){
  const raw=document.getElementById('eq_input').value.trim();
  if(!raw||raw.length<2){document.getElementById('eq_found').style.display='none';return;}
  const search=eqParseId(raw).toLowerCase();
  const found=DATA_MATERIELS.filter(m=>m.id.toLowerCase().includes(search)||m.nc.toLowerCase().includes(search)).slice(0,8);
  const dl=document.getElementById('eq_suggest');dl.innerHTML=found.map(m=>'<option value="'+esc(m.id)+'">'+esc(m.des)+'</option>').join('');
  const exact=DATA_MATERIELS.find(m=>m.id.toLowerCase()===search||m.id.toLowerCase()===raw.toLowerCase());
  const info=document.getElementById('eq_found');
  if(exact){info.innerHTML='<b>'+esc(exact.id)+'</b> â€” '+esc(exact.des)+(exact.dvp?'<br>DerniÃ¨re VP: '+dfr(exact.dvp):'');info.style.display='block';if(exact.dvp)document.getElementById('eq_date').value=exact.dvp.substring(0,10);}
  else{info.style.display='none';}
}

function eqAdd(){
  const raw=document.getElementById('eq_input').value.trim();if(!raw){showToast('Saisissez un ID','err');return;}
  const type=document.getElementById('eq_type').value;
  const dateVP=document.getElementById('eq_date').value;
  const id=eqParseId(raw);
  const mat=DATA_MATERIELS.find(m=>m.id.toLowerCase()===id.toLowerCase()||m.id.toLowerCase()===raw.toLowerCase());
  const dvp=dateVP?new Date(dateVP):new Date();
  const val=type==='C'?addMonths(dvp,12):null;
  const fullId=mat?mat.id:id;
  const etiqId=eqParseId(fullId);
  eqItems.push({id:fullId,idEtiq:etiqId,des:mat?mat.des:'',type,dvp:fmtDateEtiq(dvp),val:val?fmtDateEtiq(val):'',nc:mat?mat.nc:''});
  document.getElementById('eq_input').value='';document.getElementById('eq_found').style.display='none';
  eqRender();eqPreview();showToast('âœ“ '+id+' ajoutÃ©');
}

function eqRemove(i){eqItems.splice(i,1);eqRender();eqPreview();}
function eqClear(){eqItems=[];eqRender();eqPreview();}
function eqRender(){
  document.getElementById('eq_count').textContent=eqItems.length;
  document.getElementById('betiq').textContent=eqItems.length||'0';
  const btn=document.getElementById('eq_print_btn');btn.disabled=!eqItems.length;
  const el=document.getElementById('eq_list');
  if(!eqItems.length){el.innerHTML='<div style="text-align:center;color:var(--text3);font-size:.85rem;padding:20px">Scannez ou tapez un ID matÃ©riel pour commencer</div>';return;}
  el.innerHTML=eqItems.map((it,i)=>{const shortId=it.idEtiq||it.id;const showFull=it.id!==shortId?' <span style="font-size:.6rem;color:var(--text3)">('+esc(it.id)+')</span>':'';return '<div class="eq-item"><span class="eq-type '+(it.type==='C'?'c':'nc')+'">'+(it.type==='C'?'âœ“ C':'âœ— NC')+'</span><div class="eq-mid"><div class="eq-id">'+esc(shortId)+showFull+'</div><div class="eq-des">'+esc(it.des)+'</div><div class="eq-dates">VP: '+it.dvp+(it.val?' â†’ VAL: '+it.val:'')+'</div></div><button class="eq-del" onclick="eqRemove('+i+')">âœ•</button></div>';}).join('');
}

function eqPreview(){
  const canvas=document.getElementById('eq_canvas');const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!eqItems.length)return;
  const last=eqItems[eqItems.length-1];
  const isNC=last.type==='NC';
  const img=new Image();
  img.onload=function(){
    // Image 592x336 (C) ou 592x337 (NC), canvas 302x144
    const sx=canvas.width/592;const sy=canvas.height/(isNC?337:336);
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
    ctx.fillStyle='#000';ctx.textAlign='center';ctx.textBaseline='middle';
    if(!isNC){
      // VALIDITÃ‰ : centre zone x=393 (dÃ©calÃ© droite), y=87
      ctx.font='bold '+Math.round(38*sx)+'px sans-serif';
      ctx.fillText(last.val||'',393*sx,87*sy);
      // VP : centre zone (373, 170)
      ctx.font='bold '+Math.round(34*sx)+'px sans-serif';
      ctx.fillText(last.dvp||'',373*sx,170*sy);
      // ID : centre zone (373, 262) descendu
      ctx.fillText(last.idEtiq||last.id||'',373*sx,262*sy);
    } else {
      // Date contrÃ´le : centre zone (249, 257)
      ctx.font='bold '+Math.round(34*sx)+'px sans-serif';
      ctx.fillText(last.dvp||'',249*sx,257*sy);
    }
  };
  img.src=isNC?ETIQ_IMG_NC:ETIQ_IMG_C;
}

// â”€â”€ Son bip pour scan QR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function eqBeep(){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator();const gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    osc.type='sine';osc.frequency.value=1200;
    gain.gain.value=0.3;
    osc.start();osc.stop(ctx.currentTime+0.12);
  }catch(e){}
}

// â”€â”€ Gestion appui court / long sur bouton scanner â”€â”€â”€â”€â”€â”€â”€â”€
let eqScanMulti=false;  // false=single, true=multi
let eqScanTimer=null;
let eqScanCount=0;
let eqLastScanned='';   // Ã©viter double scan du mÃªme QR

(function(){
  const btn=document.getElementById('eqScanBtn');
  // Appui long = multi-scan (>500ms)
  btn.addEventListener('pointerdown',function(e){
    eqScanMulti=false;
    eqScanTimer=setTimeout(function(){eqScanMulti=true;},500);
  });
  btn.addEventListener('pointerup',function(e){
    clearTimeout(eqScanTimer);
    eqStartScan(eqScanMulti);
  });
  btn.addEventListener('pointercancel',function(e){
    clearTimeout(eqScanTimer);
  });
})();

function eqStartScan(multi){
  if(!window.isSecureContext){showToast('CamÃ©ra indisponible (HTTPS requis)','err');return;}
  if(!('BarcodeDetector' in window)){showToast('BarcodeDetector non supportÃ© par ce navigateur','err');return;}
  eqScanMulti=multi;
  eqScanCount=0;
  eqLastScanned='';
  const modal=document.getElementById('qrModal');modal.classList.add('open');
  document.getElementById('qrMode').textContent=multi?'MODE MULTI-SCAN (appuyez Fermer pour arrÃªter)':'MODE SCAN UNIQUE';
  document.getElementById('qrCount').textContent='';
  const reader=document.getElementById('qrReader');
  const video=document.createElement('video');video.setAttribute('playsinline','');video.autoplay=true;
  reader.innerHTML='';reader.appendChild(video);
  navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(function(stream){
    video.srcObject=stream;
    const detector=new BarcodeDetector({formats:['qr_code']});
    qrScanner=setInterval(function(){
      if(video.readyState>=2){
        detector.detect(video).then(function(codes){
          if(codes.length){
            const val=codes[0].rawValue;
            // Ã‰viter double dÃ©tection du mÃªme code
            if(val===eqLastScanned)return;
            eqLastScanned=val;
            // Reset aprÃ¨s 2s pour pouvoir rescanner le mÃªme
            setTimeout(function(){if(eqLastScanned===val)eqLastScanned='';},2000);
            eqBeep();
            eqScanCount++;
            // Remplir et ajouter automatiquement
            document.getElementById('eq_input').value=val;
            eqAutoComplete();
            if(eqScanMulti){
              // Multi-scan : ajouter directement et continuer
              eqAdd();
              document.getElementById('qrCount').textContent='âœ“ '+eqScanCount+' scannÃ©'+(eqScanCount>1?'s':'');
            }else{
              // Single : fermer aprÃ¨s 1 scan
              showToast('QR: '+val);
              eqScanStop();
            }
          }
        }).catch(function(){});
      }
    },300);
  }).catch(function(){showToast('AccÃ¨s camÃ©ra refusÃ©','err');modal.classList.remove('open');});
}

function eqScanStop(){
  if(qrScanner){clearInterval(qrScanner);qrScanner=null;}
  const reader=document.getElementById('qrReader');const video=reader.querySelector('video');
  if(video&&video.srcObject){video.srcObject.getTracks().forEach(function(t){t.stop();});}
  reader.innerHTML='';document.getElementById('qrModal').classList.remove('open');
  if(eqScanCount>0&&eqScanMulti){showToast('âœ“ '+eqScanCount+' Ã©tiquette'+(eqScanCount>1?'s':'')+' ajoutÃ©e'+(eqScanCount>1?'s':''));}
  eqScanCount=0;
}

function eqPrint(){
  if(!eqItems.length)return;
  const promises=eqItems.map(it=>{
    return new Promise(resolve=>{
      const isNC=it.type==='NC';
      const canvas=document.createElement('canvas');canvas.width=592;canvas.height=isNC?337:336;
      const ctx=canvas.getContext('2d');const img=new Image();
      img.onload=function(){
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        ctx.fillStyle='#000';ctx.textAlign='center';ctx.textBaseline='middle';
        if(!isNC){
          ctx.font='bold 38px sans-serif';ctx.fillText(it.val||'',393,87);
          ctx.font='bold 34px sans-serif';ctx.fillText(it.dvp||'',373,170);
          ctx.fillText(it.idEtiq||it.id||'',373,262);
        } else {
          ctx.font='bold 34px sans-serif';ctx.fillText(it.dvp||'',249,257);
        }
        resolve(canvas.toDataURL('image/png'));
      };
      img.src=isNC?ETIQ_IMG_NC:ETIQ_IMG_C;
    });
  });
  Promise.all(promises).then(dataUrls=>{
    const win=window.open('','_blank');
    if(!win){showToast('Popup bloquÃ©e - autorisez les popups','err');return;}
    let html='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Ã‰tiquettes Bertin</title><style>';
    html+='@page{size:landscape;margin:2mm}body{margin:0;padding:0}.etiq{page-break-after:always;text-align:center;padding:0}.etiq:last-child{page-break-after:auto}.etiq img{width:108pt;height:auto;display:block;margin:0 auto}';
    html+='</style></head><body>';
    dataUrls.forEach(url=>{html+='<div class="etiq"><img src="'+url+'"></div>';});
    html+='<script>setTimeout(()=>{window.print()},400)<\/script></body></html>';
    win.document.write(html);win.document.close();
    showToast('âœ“ '+eqItems.length+' Ã©tiquette(s) gÃ©nÃ©rÃ©e(s)');
  });
}

// Init date Ã©tiquettes
document.getElementById('eq_date').value=new Date().toISOString().split('T')[0];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
buildFilters(DATA_CONSTATS,'c','fcats','setCcat');
buildFilters(DATA_MATERIELS,'cnpe','fmcnpe','setMcnpe');
buildFilters(DATA_MATERIELS,'ctr','fmctr','setMctr');
renderConstats();
refreshE();
renderMateriels();
initCalc();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVICE WORKER â€” Enregistrement + DÃ©tection MAJ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let swWaiting = null;

function applyUpdate() {
  if (swWaiting) {
    // Dire au nouveau SW de prendre le contrÃ´le
    swWaiting.postMessage({ type: 'SKIP_WAITING' });
  } else {
    // Fallback : recharger simplement
    window.location.reload();
  }
}

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').then(function(reg) {

    // 1. VÃ©rifier immÃ©diatement si une MAJ est dÃ©jÃ  en attente
    if (reg.waiting) {
      swWaiting = reg.waiting;
      document.getElementById('updateBar').classList.add('show');
    }

    // 2. Ã‰couter les futures MAJ
    reg.addEventListener('updatefound', function() {
      var newSW = reg.installing;
      if (!newSW) return;
      newSW.addEventListener('statechange', function() {
        // Le nouveau SW est installÃ© et attend d'Ãªtre activÃ©
        if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
          swWaiting = newSW;
          document.getElementById('updateBar').classList.add('show');
        }
      });
    });

    // 3. Forcer la vÃ©rification de MAJ Ã  chaque ouverture
    reg.update().catch(function() {});

    // 4. Re-vÃ©rifier pÃ©riodiquement (toutes les 30 min)
    setInterval(function() {
      reg.update().catch(function() {});
    }, 30 * 60 * 1000);

  }).catch(function() {});

  // 5. Quand le nouveau SW prend le contrÃ´le â†’ recharger la page
  navigator.serviceWorker.addEventListener('controllerchange', function() {
    window.location.reload();
  });
}
</script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ONGLET 6 â€” RADIAMÃˆTRES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RD_PDF_B64='%%RADIA_PDF_B64%%';

// Session state
let rdSession = LS.get('radia_session', { items: [], counter: 0 });
let rdConfig = LS.get('radia_config', {});
let rdCurrentIdx = -1; // -1=config, -2=add, >=0=item index

function rdSaveSession(){ LS.set('radia_session', rdSession); }
function rdSaveConfig(){
  rdConfig = {
    operateur: document.getElementById('rd_operateur').value,
    trigramme: document.getElementById('rd_trigramme').value.toUpperCase(),
    controleur: document.getElementById('rd_controleur').value,
    site: document.getElementById('rd_site').value,
    intervention: document.getElementById('rd_intervention').value,
    date: document.getElementById('rd_date').value,
    banc_id: document.getElementById('rd_banc').value
  };
  LS.set('radia_config', rdConfig);
}

function rdInit(){
  // Load config
  const c = rdConfig;
  if(c.operateur) document.getElementById('rd_operateur').value = c.operateur;
  if(c.trigramme) document.getElementById('rd_trigramme').value = c.trigramme;
  if(c.controleur) document.getElementById('rd_controleur').value = c.controleur;
  if(c.site) document.getElementById('rd_site').value = c.site;
  if(c.intervention) document.getElementById('rd_intervention').value = c.intervention;
  document.getElementById('rd_date').value = c.date || new Date().toISOString().slice(0,10);
  // Populate bancs from etalons (category containing 'Irrad' or similar)
  rdPopulateBancs();
  if(c.banc_id) { document.getElementById('rd_banc').value = c.banc_id; rdSelectBanc(); }
  // Populate matÃ©riel datalist
  rdPopulateMatList();
  // Render sidebar
  rdRenderSidebar();
  rdUpdateStats();
  // Add button
  document.getElementById('rd_add_btn').onclick = function(){ rdShowAdd(); };
}

function rdPopulateBancs(){
  const etalons = getEtalons();
  const sel = document.getElementById('rd_banc');
  sel.innerHTML = '<option value="">â€” SÃ©lectionner un banc â€”</option>';
  // Find etalons with cat containing 'Irrad' or 'Banc' or 'irrad'
  etalons.forEach(function(e){
    if(e.cat && (e.cat.toLowerCase().includes('irrad') || e.cat.toLowerCase().includes('banc'))){
      const label = e.id + (e.loc ? ' - ' + e.loc : '');
      sel.innerHTML += '<option value="'+esc(e.id)+'">'+esc(label)+'</option>';
    }
  });
}

function rdSelectBanc(){
  const bancId = document.getElementById('rd_banc').value;
  const info = document.getElementById('rd_banc_info');
  if(!bancId){ info.style.display='none'; rdSaveConfig(); return; }
  const etalons = getEtalons();
  const banc = etalons.find(function(e){ return e.id === bancId; });
  if(!banc){ info.style.display='none'; rdSaveConfig(); return; }
  info.style.display='block';
  // Extract d1, d2 from champs
  let d1='â€“', d2='â€“', model='â€“';
  if(banc.ch) banc.ch.forEach(function(c){
    const ll = c.l.toLowerCase();
    if(ll.includes('distance') && ll.includes('1') || ll.includes('d1')) d1 = c.v;
    if(ll.includes('distance') && ll.includes('2') || ll.includes('d2')) d2 = c.v;
    if(ll.includes('modÃ¨le') || ll.includes('model') || ll.includes('raccordement') || ll.includes('Ã©talon')) model = c.v;
  });
  document.getElementById('rd_d1').textContent = d1;
  document.getElementById('rd_d2').textContent = d2;
  document.getElementById('rd_loc').textContent = banc.loc || 'â€“';
  document.getElementById('rd_val_banc').textContent = banc.val ? dfr(banc.val) : 'â€“';
  document.getElementById('rd_model').textContent = model;
  rdSaveConfig();
}

function rdGetBancData(){
  const bancId = rdConfig.banc_id;
  if(!bancId) return {d1:'',d2:'',loc:'',val:'',model:''};
  const etalons = getEtalons();
  const banc = etalons.find(function(e){ return e.id === bancId; });
  if(!banc) return {d1:'',d2:'',loc:'',val:'',model:''};
  let d1='', d2='', model='';
  if(banc.ch) banc.ch.forEach(function(c){
    const ll = c.l.toLowerCase();
    if(ll.includes('distance') && ll.includes('1') || ll.includes('d1')) d1 = c.v;
    if(ll.includes('distance') && ll.includes('2') || ll.includes('d2')) d2 = c.v;
    if(ll.includes('modÃ¨le') || ll.includes('model') || ll.includes('raccordement') || ll.includes('Ã©talon')) model = c.v;
  });
  return {d1:d1, d2:d2, loc:banc.loc||'', val:banc.val?dfr(banc.val):'', model:model};
}

function rdPopulateMatList(){
  const dl = document.getElementById('rd_mat_list');
  dl.innerHTML = '';
  if(typeof DATA_MATERIELS === 'undefined') return;
  DATA_MATERIELS.forEach(function(m){
    const o = document.createElement('option');
    o.value = m.id || m.code || '';
    o.textContent = (m.desc||m.type||'') + ' - ' + (m.ns||'');
    dl.appendChild(o);
  });
}

// â”€â”€ SIDEBAR RENDERING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rdRenderSidebar(){
  const list = document.getElementById('rd_list');
  list.innerHTML = '';
  rdSession.items.forEach(function(it, idx){
    const st = rdItemStatus(it);
    const div = document.createElement('div');
    div.className = 'rd-side-item' + (rdCurrentIdx===idx?' active':'');
    div.onclick = function(){ rdShowItem(idx); };
    div.innerHTML =
      '<div class="rd-side-icon">' + (st==='ok'?'âœ“':st==='ng'?'âœ—':st==='partial'?'âš ':'â³') + '</div>' +
      '<div class="rd-side-label">' + esc(it.type_short || '?') + '</div>' +
      '<div class="rd-side-label" style="color:var(--accent);font-weight:700">' + esc(it.id_short || it.code || '?') + '</div>' +
      '<div class="rd-side-status ' + st + '">' + (st==='ok'?'CONFORME':st==='ng'?'NON-CONF':st==='partial'?'PARTIEL':'ATTENTE') + '</div>';
    list.appendChild(div);
  });
  rdUpdateStats();
}

function rdItemStatus(it){
  if(!it.ded1 && !it.ded2) return 'wait';
  const j = rdCalcJugementFor(it);
  if(j === null) return 'partial';
  return j ? 'ok' : 'ng';
}

function rdCalcJugementFor(it){
  if(!it.ded1 || !it.ded2) return null;
  const d1 = parseFloat(it.ded1);
  const d2 = parseFloat(it.ded2);
  if(isNaN(d1)||isNaN(d2)) return null;
  const ok1 = d1 >= 0.7 && d1 <= 1.3;
  const ok2 = d2 >= 63 && d2 <= 117;
  const checks = (it.aspect!=='DÃ©gradÃ©') && (it.batterie!=='Non-conforme') && (it.son!=='Non-conforme') &&
                 (it.sonde!=='Non-conforme') && ok1 && ok2;
  return checks;
}

function rdUpdateStats(){
  const total = rdSession.items.length;
  let ok=0, ng=0;
  rdSession.items.forEach(function(it){
    const j = rdCalcJugementFor(it);
    if(j===true) ok++;
    else if(j===false) ng++;
  });
  const el = document.getElementById('rd_stats');
  if(total===0){
    el.innerHTML = 'Aucun appareil dans la session';
  } else {
    el.innerHTML = '<span class="sc">'+ok+' âœ“</span> conforme'+(ok>1?'s':'') +
      ' Â· <span class="snc">'+ng+' âœ—</span> NC Â· '+total+' total';
  }
  document.getElementById('rd_btn_pdf').disabled = total===0;
  document.getElementById('rd_btn_csv').disabled = total===0;
  // Update tab badge
  const badge = document.getElementById('bradia');
  if(badge) badge.textContent = total || '0';
}

// â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rdShowConfig(){
  rdCurrentIdx = -1;
  rdShowPanel('rd_config');
  rdRenderSidebar();
  document.querySelector('.rd-config').classList.add('active');
}

function rdShowAdd(){
  rdCurrentIdx = -2;
  rdShowPanel('rd_add');
  rdRenderSidebar();
  document.getElementById('rd_scan_input').value = '';
  document.getElementById('rd_lookup_info').style.display = 'none';
  document.getElementById('rd_add_confirm').disabled = true;
  document.getElementById('rd_scan_input').focus();
}

function rdShowItem(idx){
  rdCurrentIdx = idx;
  rdShowPanel('rd_constat');
  rdRenderSidebar();
  rdLoadItem(idx);
}

function rdShowPanel(id){
  ['rd_config','rd_add','rd_constat'].forEach(function(p){
    document.getElementById(p).style.display = p===id?'block':'none';
  });
}

// â”€â”€ LOOKUP MATÃ‰RIEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rdLookup(){
  const code = document.getElementById('rd_scan_input').value.trim();
  const info = document.getElementById('rd_lookup_info');
  if(!code){ info.style.display='none'; document.getElementById('rd_add_confirm').disabled=true; return; }
  document.getElementById('rd_add_confirm').disabled = false;
  // Search in DATA_MATERIELS
  if(typeof DATA_MATERIELS !== 'undefined'){
    const mat = DATA_MATERIELS.find(function(m){ return (m.id||m.code||'') === code; });
    if(mat){
      info.style.display='block';
      document.getElementById('rd_lu_type').textContent = mat.desc || mat.type || 'â€“';
      document.getElementById('rd_lu_sn').textContent = mat.ns || 'â€“';
      return;
    }
  }
  info.style.display='none';
}

function rdParseId(raw){
  if(!raw) return raw;
  const i = raw.lastIndexOf('-');
  return i > 0 ? raw.substring(i+1) : raw;
}

function rdGetTypeShort(desc){
  if(!desc) return '?';
  // Extract first meaningful word: "DOLPHY GAMMA - (GAMMA...)" -> "Dolphy"
  const m = desc.match(/^([A-Za-z0-9]+)/);
  return m ? m[1] : desc.substring(0,8);
}

// â”€â”€ ADD APPAREIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rdAddAppareil(){
  const code = document.getElementById('rd_scan_input').value.trim();
  if(!code){ toast('Saisir un code matÃ©riel',true); return; }
  // Check duplicate
  if(rdSession.items.find(function(it){ return it.code === code; })){
    toast('DÃ©jÃ  dans la session',true); return;
  }
  // Lookup
  let type_radia='', sn='', corim='', desc='';
  if(typeof DATA_MATERIELS !== 'undefined'){
    const mat = DATA_MATERIELS.find(function(m){ return (m.id||m.code||'') === code; });
    if(mat){
      desc = mat.desc || mat.type || '';
      sn = mat.ns || '';
      corim = mat.corim || '';
    }
  }
  type_radia = desc;
  const id_short = rdParseId(code);
  const type_short = rdGetTypeShort(desc);
  // Generate constat number
  rdSession.counter++;
  const tri = (rdConfig.trigramme || 'XXX').toUpperCase();
  const dt = rdConfig.date || new Date().toISOString().slice(0,10);
  const dp = dt.replace(/-/g,'').slice(2); // AAMMJJ
  const cnum = String(rdSession.counter).padStart(4,'0');
  const numConstat = tri + dp + cnum + 'C';

  const bancData = rdGetBancData();
  const item = {
    code: code,
    id_short: id_short,
    type_short: type_short,
    type_radia: type_radia,
    sn: sn,
    corim: corim,
    numConstat: numConstat,
    aspect: 'Correct',
    batterie: 'Conforme',
    son: 'Conforme',
    sonde: 'Sans objet',
    maj: 'Sans objet',
    d1: bancData.d1,
    d2: bancData.d2,
    ded1: '',
    ded2: '',
    comment: '',
    jugement: null
  };
  rdSession.items.push(item);
  rdSaveSession();
  rdRenderSidebar();
  rdShowItem(rdSession.items.length - 1);
  toast('âœ“ ' + id_short + ' ajoutÃ©');
}

// â”€â”€ LOAD/SAVE ITEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rdLoadItem(idx){
  const it = rdSession.items[idx];
  if(!it) return;
  document.getElementById('rd_cst_title').textContent = 'â˜¢ ' + (it.type_short||'?') + ' â€” ' + (it.id_short||it.code);
  document.getElementById('rd_cst_header').innerHTML =
    '<div style="display:flex;justify-content:space-between"><span>Code : <strong style="color:var(--accent)">'+esc(it.code)+'</strong></span></div>';
  document.getElementById('rd_c_type').value = it.type_radia || '';
  document.getElementById('rd_c_sn').value = it.sn || '';
  document.getElementById('rd_c_corim').value = it.corim || '';
  document.getElementById('rd_c_numcst').value = it.numConstat || '';
  // Radio buttons
  rdSetRadio('rd_c_aspect', it.aspect || 'Correct');
  rdSetRadio('rd_c_batterie', it.batterie || 'Conforme');
  rdSetRadio('rd_c_son', it.son || 'Conforme');
  rdSetRadio('rd_c_sonde', it.sonde || 'Sans objet');
  rdSetRadio('rd_c_maj', it.maj || 'Sans objet');
  // Mesures
  document.getElementById('rd_c_d1').value = it.d1 || '';
  document.getElementById('rd_c_d2').value = it.d2 || '';
  document.getElementById('rd_c_ded1').value = it.ded1 || '';
  document.getElementById('rd_c_ded2').value = it.ded2 || '';
  document.getElementById('rd_c_comment').value = it.comment || '';
  rdCalcJugement();
}

function rdSaveItem(){
  if(rdCurrentIdx < 0) return;
  const it = rdSession.items[rdCurrentIdx];
  if(!it) return;
  it.type_radia = document.getElementById('rd_c_type').value;
  it.type_short = rdGetTypeShort(it.type_radia);
  it.sn = document.getElementById('rd_c_sn').value;
  it.corim = document.getElementById('rd_c_corim').value;
  it.aspect = rdGetRadio('rd_c_aspect');
  it.batterie = rdGetRadio('rd_c_batterie');
  it.son = rdGetRadio('rd_c_son');
  it.sonde = rdGetRadio('rd_c_sonde');
  it.maj = rdGetRadio('rd_c_maj');
  it.ded1 = document.getElementById('rd_c_ded1').value;
  it.ded2 = document.getElementById('rd_c_ded2').value;
  it.comment = document.getElementById('rd_c_comment').value;
  rdSaveSession();
  rdRenderSidebar();
}

function rdDeleteItem(){
  if(rdCurrentIdx < 0) return;
  if(!confirm('Supprimer cet appareil ?')) return;
  rdSession.items.splice(rdCurrentIdx, 1);
  rdSaveSession();
  rdRenderSidebar();
  rdShowConfig();
}

// â”€â”€ RADIO BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rdRadio(btn){
  btn.parentElement.querySelectorAll('.rr').forEach(function(b){ b.classList.remove('active'); });
  btn.classList.add('active');
  rdSaveItem();
  rdCalcJugement();
}
function rdSetRadio(containerId, val){
  const el = document.getElementById(containerId);
  el.querySelectorAll('.rr').forEach(function(b){
    b.classList.toggle('active', b.getAttribute('data-v') === val);
  });
}
function rdGetRadio(containerId){
  const el = document.getElementById(containerId);
  const active = el.querySelector('.rr.active');
  return active ? active.getAttribute('data-v') : '';
}

// â”€â”€ JUGEMENT AUTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rdCalcJugement(){
  rdSaveItem();
  if(rdCurrentIdx < 0) return;
  const it = rdSession.items[rdCurrentIdx];
  const el = document.getElementById('rd_c_jugement');
  const d1v = parseFloat(it.ded1);
  const d2v = parseFloat(it.ded2);
  // Tolerance indicators
  const t1 = document.getElementById('rd_c_ded1_tol');
  const t2 = document.getElementById('rd_c_ded2_tol');
  t1.className = 'rd-mg-tol' + (!isNaN(d1v) ? (d1v>=0.7&&d1v<=1.3?' ok':' ng') : '');
  t2.className = 'rd-mg-tol' + (!isNaN(d2v) ? (d2v>=63&&d2v<=117?' ok':' ng') : '');

  const j = rdCalcJugementFor(it);
  if(j === null){
    el.textContent = 'â³ EN ATTENTE (saisir DeD1 et DeD2)';
    el.className = 'rd-jugement wait';
  } else if(j){
    el.textContent = 'âœ“ CONFORME';
    el.className = 'rd-jugement ok';
  } else {
    el.textContent = 'âœ— NON-CONFORME';
    el.className = 'rd-jugement ng';
  }
  it.jugement = j;
  rdSaveSession();
  rdRenderSidebar();
}

// â”€â”€ SCANNER QR (reuse etiquettes scanner) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rdStartScan(){
  if(!('BarcodeDetector' in window)){
    toast('Scanner QR non disponible sur ce navigateur',true); return;
  }
  const modal = document.getElementById('qrModal');
  document.getElementById('qrMode').textContent = 'MODE SCAN UNIQUE â€” RADIAMÃˆTRE';
  document.getElementById('qrCount').textContent = '';
  modal.classList.add('open');
  const reader = document.getElementById('qrReader');
  reader.innerHTML = '';
  const video = document.createElement('video');
  video.setAttribute('playsinline','');
  video.style.cssText = 'width:100%;border-radius:8px';
  reader.appendChild(video);
  navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(function(stream){
    video.srcObject = stream;
    video.play();
    const detector = new BarcodeDetector({formats:['qr_code']});
    const scan = function(){
      if(!modal.classList.contains('open')){
        stream.getTracks().forEach(function(t){t.stop();}); return;
      }
      detector.detect(video).then(function(barcodes){
        if(barcodes.length > 0){
          const val = barcodes[0].rawValue;
          document.getElementById('rd_scan_input').value = val;
          rdLookup();
          eqBeep();
          stream.getTracks().forEach(function(t){t.stop();});
          modal.classList.remove('open');
          return;
        }
        requestAnimationFrame(scan);
      }).catch(function(){ requestAnimationFrame(scan); });
    };
    requestAnimationFrame(scan);
  }).catch(function(err){
    toast('CamÃ©ra non accessible: '+err.message, true);
    modal.classList.remove('open');
  });
}

// â”€â”€ CLEAR SESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rdClearSession(){
  if(!confirm('Vider toute la session ? Les donnÃ©es seront perdues.')) return;
  rdSession = { items: [], counter: 0 };
  rdSaveSession();
  rdRenderSidebar();
  rdShowConfig();
  toast('Session vidÃ©e');
}

// â”€â”€ CSV EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rdExportCSV(){
  if(!rdSession.items.length) return;
  const sep = ';';
  const header = ['Scan code client','NÂ° client simplifiÃ©','Type d\'appareil','NumÃ©ro du constat',
    'NumÃ©ro de sÃ©rie','NumÃ©ro CORIM','Aspect','Charge batterie','Son et affichage',
    'Reco sonde','Maj Date','DeD 1','DeD2','Jugement','Date essai'].join(sep);
  const rows = rdSession.items.map(function(it){
    const j = rdCalcJugementFor(it);
    return [
      it.code, it.id_short, it.type_radia, it.numConstat,
      it.sn, it.corim || '-', it.aspect, it.batterie, it.son,
      it.sonde, it.maj, it.ded1, it.ded2,
      j===true?'CONFORME':j===false?'NON-CONFORME':'EN ATTENTE',
      rdConfig.date || ''
    ].join(sep);
  });
  const bom = '\uFEFF';
  const csv = bom + header + '\n' + rows.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const dt = (rdConfig.date||new Date().toISOString().slice(0,10)).replace(/-/g,'');
  a.download = 'Radiametres_' + dt + '.csv';
  a.click();
  toast('âœ“ CSV exportÃ©');
}

// â”€â”€ PDF GENERATION (using pdf-lib in browser) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function rdLoadPdfLib(){
  if(window.PDFLib) return;
  // Load pdf-lib from CDN (cached by SW)
  return new Promise(function(resolve, reject){
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js';
    s.onload = resolve;
    s.onerror = function(){ reject(new Error('pdf-lib non chargÃ©')); };
    document.head.appendChild(s);
  });
}

async function rdGenPDF(it){
  await rdLoadPdfLib();
  const { PDFDocument, rgb, StandardFonts } = PDFLib;

  // Decode template PDF
  const pdfBytes = Uint8Array.from(atob(RD_PDF_B64), function(c){ return c.charCodeAt(0); });
  const pdfDoc = await PDFDocument.load(pdfBytes);
  const page = pdfDoc.getPages()[0];
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const fontB = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
  const { height } = page.getSize();

  // Helper: draw text at PDF coordinates (origin top-left â†’ pdf-lib uses bottom-left)
  function txt(x, y, text, size, bold){
    if(!text) return;
    page.drawText(String(text), {
      x: x,
      y: height - y,
      size: size || 9,
      font: bold ? fontB : font,
      color: rgb(0, 0, 0)
    });
  }
  function txtRed(x, y, text, size){
    if(!text) return;
    page.drawText(String(text), {
      x: x,
      y: height - y,
      size: size || 9,
      font: fontB,
      color: rgb(0.8, 0, 0)
    });
  }

  const bancData = rdGetBancData();
  const j = rdCalcJugementFor(it);
  const conforme = j === true;
  const dateEssai = rdConfig.date || new Date().toISOString().slice(0,10);
  const dp = dateEssai.split('-');
  const dateFr = dp[2]+'/'+dp[1]+'/'+dp[0];
  // Date validitÃ© = +12 mois si conforme
  let dateVal = '';
  if(conforme && dp.length===3){
    const dv = new Date(parseInt(dp[0]), parseInt(dp[1])-1, parseInt(dp[2]));
    dv.setFullYear(dv.getFullYear()+1);
    dateVal = String(dv.getDate()).padStart(2,'0')+'/'+String(dv.getMonth()+1).padStart(2,'0')+'/'+dv.getFullYear();
  }

  // Fill fields (positions calibrated from test)
  txt(415, 98, it.numConstat, 9);
  txt(415, 178, rdConfig.site || '', 9);
  txt(415, 192, dateFr, 9);
  txt(415, 205, rdConfig.intervention || '', 9);

  // Instrument table
  txt(148, 250, it.type_radia || '', 8);
  txt(318, 250, it.sn || '', 8);
  txt(393, 250, it.id_short || '', 8);
  txt(468, 250, it.corim || '-', 8);

  // Jugement
  if(conforme){
    txt(175, 295, 'CONFORME', 11, true);
  } else {
    txtRed(175, 295, 'NON-CONFORME', 11);
  }
  if(dateVal) txt(278, 305, dateVal, 9);

  // Equipments
  txt(195, 376, rdConfig.banc_id || '', 9);
  txt(345, 376, bancData.loc, 9);
  txt(475, 376, bancData.val, 9);
  txt(465, 389, bancData.model, 8);

  // OpÃ©rateur / ContrÃ´leur
  txt(215, 429, rdConfig.operateur || '', 9);
  txt(215, 456, rdConfig.controleur || '', 9);

  // Mesures table (col "Valeur avant Ajustage" starts at x=300)
  txt(300, 535, it.aspect || '', 8);
  txt(300, 548, it.batterie || '', 8);
  txt(300, 574, it.son || '', 8);
  txt(300, 587, it.sonde || '', 8);
  txt(300, 600, it.maj || '', 8);
  txt(300, 627, it.d1 || '', 8);
  txt(300, 640, it.ded1 ? String(it.ded1).replace('.',',') : '', 8);
  txt(300, 653, it.d2 || '', 8);
  txt(300, 666, it.ded2 || '', 8);

  // Commentaires
  txt(60, 715, it.comment || '', 8);

  return await pdfDoc.save();
}

function rdPdfName(it){
  const dateEssai = rdConfig.date || new Date().toISOString().slice(0,10);
  const dp = dateEssai.split('-');
  const datePart = dp[0].slice(2)+'-'+dp[1]+'-'+dp[2]; // AA-MM-JJ
  const j = rdCalcJugementFor(it);
  const suffix = j===true ? 'C' : 'NC';
  const code = it.code || ('INCONNU-' + (it.id_short || 'X'));
  return code + '-' + datePart + '_' + suffix + '.pdf';
}

async function rdGenOnePDF(){
  if(rdCurrentIdx < 0) return;
  const it = rdSession.items[rdCurrentIdx];
  try {
    toast('GÃ©nÃ©ration PDF...');
    const bytes = await rdGenPDF(it);
    const blob = new Blob([bytes], {type:'application/pdf'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = rdPdfName(it);
    a.click();
    toast('âœ“ PDF gÃ©nÃ©rÃ© : ' + rdPdfName(it));
  } catch(err) {
    toast('Erreur PDF : ' + err.message, true);
    console.error(err);
  }
}

async function rdGenAllPDF(){
  if(!rdSession.items.length) return;
  try {
    toast('GÃ©nÃ©ration de ' + rdSession.items.length + ' PDF...');
    await rdLoadPdfLib();
    for(let i=0; i<rdSession.items.length; i++){
      const it = rdSession.items[i];
      const bytes = await rdGenPDF(it);
      const blob = new Blob([bytes], {type:'application/pdf'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = rdPdfName(it);
      a.click();
      // Small delay to avoid browser blocking multiple downloads
      await new Promise(function(r){ setTimeout(r, 300); });
    }
    toast('âœ“ ' + rdSession.items.length + ' PDF gÃ©nÃ©rÃ©s');
  } catch(err) {
    toast('Erreur PDF : ' + err.message, true);
    console.error(err);
  }
}

// Init radiamÃ¨tres au chargement
rdInit();
</body>
</html>
